<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ë–∞—Ä–±–µ—Ä—à–æ–ø ‚Äî –ó–∞–ø–∏—Å—å</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* THEME B - —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—Å–∏–Ω—è—è, –∞–∫–∫—É—Ä–∞—Ç–Ω–æ "–≤–∞—É" */
  :root{
    --bg1:#0f172a;
    --acc1:#7c3aed;
    --acc2:#06b6d4;
    --muted:#6b7280;
    --success:#10b981;
    --soft-rose:#fde7e7;
    --rose-border:#e58d8d;
    --rose-text:#8b2b2b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:linear-gradient(180deg,#fbf8ff 0,#f7f9ff 100%);color:#0f172a;padding:20px}
  .wrap{max-width:760px;margin:10px auto}
  .card{background:#fff;border-radius:16px;box-shadow:0 18px 50px rgba(3,6,23,0.06);overflow:hidden}
  .header{padding:20px;background:linear-gradient(90deg,var(--acc1),var(--acc2));color:#fff}
  .header h1{margin:0;font-size:20px}
  .header p{margin:8px 0 0 0;opacity:.95;font-size:13px}
  .form{padding:20px}
  label{display:block;font-weight:700;margin-bottom:8px;color:#0b1220}
  input[type="text"],input[type="tel"]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #e6e9f2;font-size:15px;background:#fcfdff}
  input:focus{outline:none;border-color:var(--acc1);box-shadow:0 8px 30px rgba(124,58,237,0.08)}
  .grid-dates{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:10px}
  .btn-date{padding:12px;border-radius:12px;border:0;background:#f3f4f6;cursor:pointer;font-weight:800;transition:all .18s}
  .btn-date:hover{transform:translateY(-2px)}
  .btn-date.active{background:linear-gradient(90deg,var(--acc1),var(--acc2));color:#fff;box-shadow:0 18px 40px rgba(124,58,237,0.12)}
  .grid-times{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .time-btn{padding:12px;border-radius:12px;border:0;background:#f6f7fb;cursor:pointer;font-weight:700;transition:all .12s}
  .time-btn:hover{transform:translateY(-2px)}
  .time-btn.active{background:linear-gradient(90deg,var(--acc1),var(--acc2));color:#fff}
  /* –ó–∞–Ω—è—Ç—ã–π —Å–ª–æ—Ç - –í–ê–®–ê –ü–∞—Å—Ç–µ–ª—å–Ω–∞—è —Ä–æ–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ */
  .time-btn.booked{background:var(--soft-rose);border:1px solid var(--rose-border);color:var(--rose-text);cursor:not-allowed}
  .time-btn.disabled{background:#f3f4f6;color:#94a3b8;cursor:not-allowed}
  .actions{display:flex;gap:10px;margin-top:14px;flex-direction:column}
  .btn-primary{padding:14px;border-radius:12px;border:0;background:linear-gradient(90deg,#34d399,#059669);color:#fff;font-weight:800;cursor:pointer}
  .btn-primary:disabled{opacity:.5;cursor:not-allowed}
  .btn-ghost{padding:12px;border-radius:12px;border:0;background:linear-gradient(90deg,#6366f1,#7c3aed);color:#fff;font-weight:700;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  .info{padding:12px 20px;text-align:center;color:var(--muted);font-size:13px}
  /* Modal overlay center */
  .overlay{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(7,10,20,0.45);z-index:200;backdrop-filter:blur(3px)}
  .overlay.show{display:flex;animation:fadeIn .18s ease forwards}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  .modal{width:min(680px,94%);background:#fff;border-radius:14px;padding:18px;box-shadow:0 30px 80px rgba(3,6,23,0.18);transform:translateY(8px) scale(.98);opacity:0;transition:transform .22s cubic-bezier(.2,.9,.3,1),opacity .22s}
  .overlay.show .modal{transform:translateY(0) scale(1);opacity:1}
  .modal h2{margin:6px 0 10px 0;font-size:20px}
  .modal .muted{color:var(--muted)}
  .booking-list{max-height:340px;overflow:auto;padding-right:6px;margin-top:8px}
  .booking-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:#fbfcff;margin-bottom:10px}
  .booking-item .left{display:flex;flex-direction:column}
  .small{font-size:13px;color:#334155}
  .modal .actions{display:flex;gap:10px;margin-top:12px}
  @media (max-width:520px){.grid-dates{grid-template-columns:repeat(1,1fr)} .grid-times{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" role="region" aria-label="–ó–∞–ø–∏—Å—å">
    <div class="header">
      <h1>–ë–∞—Ä–±–µ—Ä—à–æ–ø</h1>
      <p>–£–¥–æ–±–Ω–∞—è –∑–∞–ø–∏—Å—å ‚Äî –æ–¥–∏–Ω —Ä–∞–∑ –≤ –¥–µ–Ω—å. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –Ω–æ–º–µ—Ä—É –∏ Telegram ID.</p>
    </div>

    <div class="form">
      <div class="form-group">
        <label for="nameInput">–í–∞—à–µ –∏–º—è</label>
        <input id="nameInput" type="text" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
      </div>

      <div class="form-group">
        <label for="phoneInput">–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input id="phoneInput" type="tel" placeholder="+7 (999) 123-45-67" value="+7 ">
      </div>

      <div class="form-group">
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</label>
        <div id="datesGrid" class="grid-dates" aria-live="polite"></div>
      </div>

      <div id="timeBlock" class="form-group" style="display:none">
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</label>
        <div id="timesGrid" class="grid-times" aria-live="polite"></div>
      </div>

      <div class="actions">
        <button id="submitBtn" class="btn-primary" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
        <button id="myBookingsBtn" class="btn-ghost">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</button>
      </div>

      <div class="info">üìç —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 123 ‚Äî –ü–Ω‚Äì–í—Å 09:00‚Äì19:00</div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="overlay" class="overlay" onclick="overlayClick(event)" aria-hidden="true">
  <div id="modal" class="modal" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
    <!-- content injected -->
  </div>
</div>

<script>
/* ================= CONFIG =================
   –í–ê–ñ–ù–û: –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è GAS –≤—Å—Ç–∞–≤—å —Å—é–¥–∞ URL Web App
   –ù–∞–ø—Ä–∏–º–µ—Ä: https://script.google.com/macros/s/AKfy.../exec
=========================================== */
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVtgPEVrEwL_KB11ZBbG7EEtaAx-A4V8Hgn1JPscKcAIqP3j4c1KA8-z9ANTlYN0CB/exec';
/* ========================================= */

const tg = window.Telegram?.WebApp || null;
if (tg) { try { tg.ready(); tg.expand(); } catch(e){} try { if (tg.MainButton) tg.MainButton.hide(); } catch(e){} }

const nameInput = document.getElementById('nameInput');
const phoneInput = document.getElementById('phoneInput');
const datesGrid = document.getElementById('datesGrid');
const timesGrid = document.getElementById('timesGrid');
const timeBlock = document.getElementById('timeBlock');
const submitBtn = document.getElementById('submitBtn');
const myBookingsBtn = document.getElementById('myBookingsBtn');
const overlay = document.getElementById('overlay');
const modal = document.getElementById('modal');

const tgUser = tg?.initDataUnsafe?.user || {};
const userId = tgUser.id || '';
const username = tgUser.username || '';

const ALL_SLOTS = ['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00'];

let bookedSlots = {}; // map "yyyy-mm-dd_HH:MM" => true
let userDayBookings = []; // list for daily-check
let selectedDate = '';
let selectedTime = '';
let sending = false;

/* ---------- HELPERS ---------- */
function isoDate(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function toHHMM(v){ if(!v && v!==0) return ''; v = String(v).trim(); if(v.includes(':')){ const p=v.split(':'); return p.map(x=>('0'+x.replace(/\D/g,'')).slice(-2)).join(':'); } v=v.replace(/\D/g,''); if(v.length<=2) return ('0'+v).slice(-2)+':00'; if(v.length===3) return '0'+v[0]+':'+v.slice(1); if(v.length===4) return v.slice(0,2)+':'+v.slice(2); return v; }
function normalizePhone(raw){ if(!raw) return ''; let s = String(raw).replace(/\D/g,''); if(s.length===11 && s[0]==='8') s='7'+s.slice(1); if(s.length===10) s='7'+s; return s.length===11?('+'+s):s; }
function formatForUI(dateStr){ const today = isoDate(new Date()); const tomorrow = isoDate(new Date(Date.now()+86400000)); if(dateStr===today) return '–°–µ–≥–æ–¥–Ω—è'; if(dateStr===tomorrow) return '–ó–∞–≤—Ç—Ä–∞'; const d = new Date(dateStr + 'T00:00:00'); return d.toLocaleDateString('ru-RU',{weekday:'short',day:'numeric',month:'short'}); }
function safeJsonFetch(url, opts){ return fetch(url, opts).then(r=>r.text()).then(t=>{ try{return JSON.parse(t);}catch(e){return {error:'invalid_json', raw:t};}}).catch(e=>({error:'network', message:String(e)})); }

/* ---------- UI: modal ---------- */
function showModal(html){
  modal.innerHTML = html;
  overlay.classList.add('show');
  overlay.setAttribute('aria-hidden','false');
}
function closeModal(){
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
  modal.innerHTML = '';
}
function overlayClick(e){ if(e.target === overlay) closeModal(); }

/* ---------- render dates & times ---------- */
function next7Days(){
  const now = new Date(); const out = [];
  for(let i=0;i<7;i++){ const d = new Date(); d.setDate(now.getDate()+i); out.push(isoDate(d)); }
  return out;
}
function renderDates(){
  datesGrid.innerHTML = '';
  next7Days().forEach(d=>{
    const btn = document.createElement('button');
    btn.className='btn-date'; btn.textContent = formatForUI(d); btn.dataset.date = d;
    btn.addEventListener('click', ()=>selectDate(d, btn));
    datesGrid.appendChild(btn);
  });
}
function renderTimes(){
  timesGrid.innerHTML='';
  if(!selectedDate) return;
  const now = new Date();
  const threshold = new Date(now.getTime() + 60*60*1000); // now+1hour
  ALL_SLOTS.forEach(slot=>{
    const btn = document.createElement('button');
    btn.className='time-btn'; btn.textContent = slot;
    const slotDt = new Date(selectedDate + 'T' + slot + ':00');
    const key = `${selectedDate}_${slot}`;
    if(bookedSlots[key]){
      btn.classList.add('booked');
      btn.title = '–ó–∞–Ω—è—Ç–æ';
    } else if(slotDt < threshold){
      btn.classList.add('disabled');
      btn.title = '–ü—Ä–æ—à–ª–æ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ';
    } else {
      btn.addEventListener('click', ()=>selectTime(slot, btn));
    }
    timesGrid.appendChild(btn);
  });
}

/* ---------- select handlers ---------- */
function selectDate(date, el){
  selectedDate = date; selectedTime = '';
  document.querySelectorAll('.btn-date').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  timeBlock.style.display = 'block';
  renderTimes();
  updateSubmit();
}
function selectTime(time, el){
  selectedTime = toHHMM(time);
  document.querySelectorAll('.time-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  updateSubmit();
}

/* ---------- validation & mask ---------- */
phoneInput.addEventListener('input', (e)=>{
  let v = e.target.value.replace(/\D/g,'');
  if(!v.startsWith('7')) v = '7' + v.replace(/^7+/, '');
  v = v.slice(0,11);
  let fmt = '+7 ';
  if(v.length>1) fmt += '(' + v.slice(1,4);
  if(v.length>=5) fmt += ') ' + v.slice(4,7);
  if(v.length>=8) fmt += '-' + v.slice(7,9);
  if(v.length>=10) fmt += '-' + v.slice(9,11);
  e.target.value = fmt;
  updateSubmit();
});
if(tgUser.first_name && !nameInput.value) nameInput.value = tgUser.first_name + (tgUser.last_name ? (' ' + tgUser.last_name) : '');

function updateSubmit(){
  const name = nameInput.value.trim();
  const digits = phoneInput.value.replace(/\D/g,'');
  const ok = name.length>1 && digits.length===11 && selectedDate && selectedTime && !sending;
  submitBtn.disabled = !ok;
}

/* ---------- load bookings ---------- */
async function loadBookings(){
  if(!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL==='REPLACE_WITH_YOUR_WEB_APP_URL'){ console.warn('GAS URL not set'); return; }
  const res = await safeJsonFetch(GOOGLE_SCRIPT_URL + '?action=getBookings', {cache:'no-store'});
  bookedSlots = {}; userDayBookings = [];
  if(res && Array.isArray(res.bookings)){
    res.bookings.forEach(b=>{
      const t = toHHMM(b.time||'');
      const key = `${b.date}_${t}`;
      bookedSlots[key] = true;
      userDayBookings.push({date:b.date, time:t, phone: normalizePhone(b.phone||''), userId: b.userId || ''});
    });
  } else {
    if(res && res.error) console.warn('loadBookings err', res);
  }
  if(selectedDate) renderTimes();
}

/* ---------- My bookings modal (calls getUserBookings) ---------- */
async function openMyBookings(){
  if(!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL==='https://script.google.com/macros/s/AKfycbwVtgPEVrEwL_KB11ZBbG7EEtaAx-A4V8Hgn1JPscKcAIqP3j4c1KA8-z9ANTlYN0CB/exec'){
    showModal(`<h2>–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2><p class="muted">URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –∑–∞–¥–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.</p><div style="display:flex;gap:8px;margin-top:12px"><button onclick="closeModal()" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
    return;
  }
  const phone = normalizePhone(phoneInput.value);
  let qs = '?action=getUserBookings';
  if(userId) qs += '&userId=' + encodeURIComponent(String(userId));
  else if(phone) qs += '&phone=' + encodeURIComponent(String(phone));
  else { showModal(`<h2>–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2><p class="muted">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram.</p><div style="display:flex;gap:8px;margin-top:12px"><button onclick="closeModal()" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`); return; }

  showModal(`<h2>–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2><p class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</p>`);
  const res = await safeJsonFetch(GOOGLE_SCRIPT_URL + qs, {cache:'no-store'});
  if(res && Array.isArray(res.bookings) && res.bookings.length>0){
    const items = res.bookings.sort((a,b)=> (a.date + a.time).localeCompare(b.date + b.time)).map(b=>{
      return `<div class="booking-item"><div class="left"><div style="font-weight:800">${formatForUI(b.date)} ‚Äî ${toHHMM(b.time)}</div><div class="small">${b.name || ''} ${b.phone ? '‚Ä¢ ' + normalizePhone(b.phone) : ''}</div></div><div class="small muted">${b.created || ''}</div></div>`;
    }).join('');
    showModal(`<h2>–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2><div class="booking-list">${items}</div><div style="display:flex;gap:8px;margin-top:12px"><button onclick="closeModal()" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
  } else {
    const msg = (res && res.bookings && res.bookings.length===0) ? '–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π' : (res && res.error ? '–û—à–∏–±–∫–∞: ' + (res.message || res.error) : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
    showModal(`<h2>–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2><p class="muted">${msg}</p><div style="display:flex;gap:8px;margin-top:12px"><button onclick="closeModal()" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
  }
}

/* ---------- send booking ---------- */
async function sendBooking(){
  if(sending) return;
  const name = nameInput.value.trim();
  const phone = normalizePhone(phoneInput.value);
  if(!name || !phone || !selectedDate || !selectedTime) return updateSubmit();

  // local limit check (phone or userId already booked that day)
  const conflict = userDayBookings.some(b => b.date === selectedDate && (b.phone === phone || (userId && String(b.userId) === String(userId))));
  if(conflict){
    showModal(`<h2>–û—à–∏–±–∫–∞</h2><p class="muted">–í—ã —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å (–ø–æ –Ω–æ–º–µ—Ä—É –∏–ª–∏ Telegram ID).</p><div style="display:flex;gap:8px;margin-top:12px"><button onclick="closeModal()" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
    return;
  }

  sending = true; updateSubmit(); submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

  const params = new URLSearchParams();
  params.append('action','addBooking');
  params.append('name', name);
  params.append('phone', phone);
  params.append('date', selectedDate);
  params.append('time', selectedTime);
  params.append('userId', userId || '');
  params.append('username', username || '');

  const res = await safeJsonFetch(GOOGLE_SCRIPT_URL, {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
    body: params.toString()
  });

  if(res && res.status === 'success'){
    showModal(`<h2>–ó–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</h2><p class="muted">${name} ‚Ä¢ ${phone}</p><p>–î–∞—Ç–∞: <strong>${formatForUI(selectedDate)}</strong></p><p>–í—Ä–µ–º—è: <strong>${selectedTime}</strong></p><div style="display:flex;gap:8px;margin-top:12px"><button onclick="closeModal()" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
    // refresh bookings
    await loadBookings();
  } else {
    const msg = (res && res.message) ? res.message : '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ —Å–µ—Ç–∏';
    showModal(`<h2>–û—à–∏–±–∫–∞</h2><p class="muted">${msg}</p><div style="display:flex;gap:8px;margin-top:12px"><button onclick="closeModal()" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
    await loadBookings();
  }

  sending = false; submitBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å';
  updateSubmit();
}

/* events wiring */
submitBtn.addEventListener('click', sendBooking);
myBookingsBtn.addEventListener('click', openMyBookings);
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) loadBookings().catch(()=>{}); });

/* init */
(async function init(){
  renderDates();
  if(tgUser.first_name) nameInput.value = tgUser.first_name + (tgUser.last_name ? (' ' + tgUser.last_name) : '');
  await loadBookings();
  updateSubmit();
})();
</script>
</body>
</html>
