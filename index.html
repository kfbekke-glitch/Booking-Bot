<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–∞—Ä–±–µ—Ä—à–æ–ø - –ó–∞–ø–∏—Å—å</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #e0f2fe 0%, #f3e8ff 100%); min-height: 100vh; padding: 16px; }
        .container { max-width: 500px; margin: 0 auto; padding: 24px 0; }
        .card { background: white; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #9333ea 0%, #3b82f6 100%); padding: 24px; color: white; }
        .header-content { display: flex; align-items: center; gap: 12px; }
        .icon-box { background: rgba(255,255,255,0.2); padding: 8px; border-radius: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .header h1 { font-size: 24px; font-weight: bold; margin: 0; }
        .header p { color: rgba(255,255,255,0.9); font-size: 14px; margin: 4px 0 0 0; }
        .form { padding: 24px; }
        .form-group { margin-bottom: 24px; }
        .label { display: flex; align-items: center; gap: 8px; color: #374151; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        .label-icon { font-size: 16px; color: #9333ea; }
        input { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; transition: border-color 0.2s; }
        input:focus { outline: none; border-color: #9333ea; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .btn { padding: 12px 16px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 14px; text-align: center; }
        .btn-date, .btn-time { background: #f3f4f6; color: #374151; }
        .btn-date:hover, .btn-time:hover { background: #e5e7eb; }
        .btn-date.active, .btn-time.active { background: linear-gradient(135deg, #9333ea 0%, #3b82f6 100%); color: white; transform: scale(1.05); }
        .btn-time.disabled { background: rgba(239, 68, 68, 0.2); color: #dc2626; cursor: not-allowed; position: relative; }
        .btn-time.disabled:hover { background: rgba(239, 68, 68, 0.2); transform: none; }
        .btn-time.disabled::after { content: '‚úï'; position: absolute; top: 2px; right: 4px; font-size: 10px; }
        .btn-submit { width: 100%; padding: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 16px; margin-top: 8px; }
        .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-submit:not(:disabled):hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .info { margin-top: 24px; text-align: center; color: #6b7280; font-size: 14px; }
        .info p { margin: 4px 0; }
        .success-screen { text-align: center; padding: 48px 24px; }
        .success-icon { width: 80px; height: 80px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; font-size: 40px; }
        .success-screen h2 { font-size: 28px; color: #1f2937; margin-bottom: 16px; }
        .booking-details { background: #f9fafb; border-radius: 16px; padding: 16px; margin: 24px 0; text-align: left; }
        .booking-details p { color: #6b7280; margin: 8px 0; }
        .booking-details strong { color: #1f2937; }
        .hidden { display: none; }
        .loading { text-align: center; padding: 16px; color: #6b7280; }
        .spinner { border: 3px solid #f3f4f6; border-top: 3px solid #9333ea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-screen { text-align: center; padding: 48px 24px; }
        .error-icon { width: 80px; height: 80px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; font-size: 40px; }
        .alert-warning { background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .alert-warning p { color: #92400e; margin: 4px 0; font-size: 14px; }
        .alert-warning strong { color: #78350f; font-size: 16px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- –í—Å–µ –±–ª–æ–∫–∏ –∏–∑ —Ç–≤–æ–µ–≥–æ —Ñ–∞–π–ª–∞ -->
        <div id="bookingScreen" class="card">
            <div class="header">
                <div class="header-content">
                    <div class="icon-box">üìÖ</div>
                    <div>
                        <h1>–ë–∞—Ä–±–µ—Ä—à–æ–ø</h1>
                        <p>–ó–∞–ø–∏—Å—å –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É</p>
                    </div>
                </div>
            </div>
            <div class="form">
                <div class="form-group">
                    <label class="label"><span class="label-icon">üë§</span>–í–∞—à–µ –∏–º—è</label>
                    <input type="text" id="nameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
                </div>
                <div class="form-group">
                    <label class="label"><span class="label-icon">üìû</span>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" id="phoneInput" placeholder="+7 (999) 123-45-67" value="+7 ">
                </div>
                <div class="alert-warning">
                    <p><strong>üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞</strong></p>
                    <p>‚Ä¢ –ú–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å</p>
                    <p>‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ Telegram ID</p>
                </div>
                <div class="form-group">
                    <label class="label"><span class="label-icon">üìÖ</span>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</label>
                    <div id="datesGrid" class="grid-2"></div>
                </div>
                <div class="form-group" id="timeGroup" style="display: none;">
                    <label class="label"><span class="label-icon">üïê</span>–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</label>
                    <div id="timesGrid" class="grid-3">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                        </div>
                    </div>
                </div>
                <button class="btn btn-submit" id="submitBtn" onclick="handleSubmit()" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
            </div>
        </div>
        <div id="errorScreen" class="card hidden">
            <div class="error-screen">
                <div class="error-icon">‚ö†Ô∏è</div>
                <h2>–õ–∏–º–∏—Ç –∑–∞–ø–∏—Å–µ–π</h2>
                <div class="booking-details">
                    <p style="text-align: center; color: #dc2626; font-weight: 600;">–í—ã —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞–Ω—è—Ç–æ!</p>
                    <p style="text-align: center; color: #6b7280; margin-top: 12px;">–ú–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å.<br>–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è.</p>
                </div>
                <div style="text-align: center; margin-top: 16px; color: #6b7280;">
                    <p>üìû +7 (999) 123-45-67</p>
                </div>
            </div>
        </div>
        <div id="successScreen" class="card hidden">
            <div class="success-screen">
                <div class="success-icon">‚úì</div>
                <h2>–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã!</h2>
                <div class="booking-details">
                    <p><strong>–ò–º—è:</strong> <span id="successName"></span></p>
                    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="successPhone"></span></p>
                    <p><strong>–î–∞—Ç–∞:</strong> <span id="successDate"></span></p>
                    <p><strong>–í—Ä–µ–º—è:</strong> <span id="successTime"></span></p>
                </div>
                <p style="color: #6b7280; margin: 16px 0;">
                    –ñ–¥—ë–º –≤–∞—Å –≤ –±–∞—Ä–±–µ—Ä—à–æ–ø–µ!<br>–ó–∞ –¥–µ–Ω—å –¥–æ –≤–∏–∑–∏—Ç–∞ –º—ã –Ω–∞–ø–æ–º–Ω–∏–º –æ –∑–∞–ø–∏—Å–∏.
                </p>
            </div>
        </div>
        <div class="info">
            <p>üìç —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 123</p>
            <p>üìû +7 (999) 123-45-67</p>
            <p>‚è∞ –ü–Ω-–í—Å: 09:00 - 19:00</p>
        </div>
    </div>
    <script>
        let tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready(); tg.expand();
            const user = tg.initDataUnsafe?.user;
            if (user) document.getElementById('nameInput').value = user.first_name + (user.last_name ? ' ' + user.last_name : '');
        }
        const booking = { name: '', phone: '', date: '', time: '', userId: tg?.initDataUnsafe?.user?.id || null, username: tg?.initDataUnsafe?.user?.username || null };
        let bookedSlots = {};
        let userBookingsToday = [];
        const allTimeSlots = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'];
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzAqwN3gjj2wZzqPRjmUZdQOvdnqWeBFT9POGASvf9dNf5cJokacxZ4ILqw9E3gcbQN/exec';

        const phoneInput = document.getElementById('phoneInput');
        phoneInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (!value.startsWith('7')) value = '7' + value.replace(/^7+/, '');
            value = value.substring(0, 11);
            let formatted = '+7 ';
            if (value.length > 1) formatted += '(' + value.substring(1, 4);
            if (value.length >= 5) formatted += ') ' + value.substring(4, 7);
            if (value.length >= 8) formatted += '-' + value.substring(7, 9);
            if (value.length >= 10) formatted += '-' + value.substring(9, 11);
            e.target.value = formatted;
            booking.phone = value.length === 11 ? '+' + value : '';
            updateSubmitButton();
        });
        phoneInput.addEventListener('keydown', (e) => {
            const cursorPosition = e.target.selectionStart;
            if ((e.key === 'Backspace' || e.key === 'Delete') && cursorPosition <= 3) e.preventDefault();
        });
        function checkUserBookingLimit(phone, userId) {
            const today = new Date().toISOString().split('T')[0];
            const phoneBookings = userBookingsToday.filter(b => b.phone === phone && b.date === today);
            const userIdBookings = userId ? userBookingsToday.filter(b => b.userId === userId && b.date === today) : [];
            return phoneBookings.length > 0 || userIdBookings.length > 0;
        }
        async function loadBookedSlots() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getBookings');
                const data = await response.json();
                bookedSlots = {};
                userBookingsToday = [];
                if (data && data.bookings) {
                    data.bookings.forEach(bookingItem => {
                        const key = `${bookingItem.date}_${bookingItem.time}`;
                        bookedSlots[key] = true;
                        userBookingsToday.push(bookingItem);
                    });
                }
                return true;
            } catch (error) { return false; }
        }
        function isSlotBooked(date, time) {
            const key = `${date}_${time}`;
            return bookedSlots[key] === true;
        }
        function getAvailableDays() {
            const days = [];
            const now = new Date();
            const currentHour = now.getHours();
            const startDay = currentHour >= 18 ? 1 : 0;
            for (let i = startDay; i < startDay + 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() + i);
                days.push(date.toISOString().split('T')[0]);
            }
            return days;
        }
        function getAvailableTimeSlots(selectedDate) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            return allTimeSlots.filter(slot => {
                if (isSlotBooked(selectedDate, slot)) return false;
                if (selectedDate === today) {
                    const [hour, minute] = slot.split(':').map(Number);
                    if (hour < currentHour + 1) return false;
                    if (hour === currentHour + 1 && currentMinute > 0) return false;
                }
                return true;
            });
        }
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            if (dateStr === today) return '–°–µ–≥–æ–¥–Ω—è';
            if (dateStr === tomorrowStr) return '–ó–∞–≤—Ç—Ä–∞';
            return date.toLocaleDateString('ru-RU', { weekday: 'short', day: 'numeric', month: 'short' });
        }
        function renderDates() {
            const grid = document.getElementById('datesGrid');
            const days = getAvailableDays();
            grid.innerHTML = days.map(day => `<button class="btn btn-date" onclick="selectDate('${day}')">${formatDate(day)}</button>` ).join('');
        }
        function renderTimes() {
            const grid = document.getElementById('timesGrid');
            const availableSlots = getAvailableTimeSlots(booking.date);
            if (availableSlots.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #dc2626; padding: 16px; font-weight: 600;">‚ùå –ù–∞ —ç—Ç—É –¥–∞—Ç—É –≤—Å–µ —Å–ª–æ—Ç—ã –∑–∞–Ω—è—Ç—ã.<br>–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å.</p>';
                return;
            }
            grid.innerHTML = allTimeSlots.map(time => {
                const isAvailable = availableSlots.includes(time);
                const isBooked = isSlotBooked(booking.date, time);
                return `<button class="btn btn-time ${!isAvailable ? 'disabled' : ''}" onclick="${isAvailable ? `selectTime('${time}')` : 'return false'}" ${!isAvailable ? 'disabled' : ''} title="${isBooked ? '–ó–∞–Ω—è—Ç–æ' : isAvailable ? '–î–æ—Å—Ç—É–ø–Ω–æ' : '–ü—Ä–æ—à–ª–æ'}">${time}</button>`;
            }).join('');
        }
        async function selectDate(date) {
            booking.date = date;
            booking.time = '';
            document.querySelectorAll('.btn-date').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            const timeGroup = document.getElementById('timeGroup');
            const timesGrid = document.getElementById('timesGrid');
            timeGroup.style.display = 'block';
            timesGrid.innerHTML = '<div class="loading"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ—Ç–æ–≤...</p></div>';
            await loadBookedSlots();
            renderTimes();
            updateSubmitButton();
        }
        function selectTime(time) {
            booking.time = time;
            document.querySelectorAll('.btn-time').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateSubmitButton();
        }
        document.getElementById('nameInput').addEventListener('input', (e) => { booking.name = e.target.value; updateSubmitButton(); });
        function updateSubmitButton() {
            const btn = document.getElementById('submitBtn');
            const isValid = booking.name && booking.phone && booking.date && booking.time;
            btn.disabled = !isValid;
            if (tg) {
                if (isValid) {
                    tg.MainButton.setText('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å ‚úÖ');
                    tg.MainButton.show();
                    tg.MainButton.onClick(handleSubmit);
                } else {
                    tg.MainButton.hide();
                }
            }
        }
        async function sendToGoogleSheets(booking) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(booking)
                });
                const result = await response.json();
                if (result.status === 'error') {
                    alert(result.message || '–≠—Ç–æ –≤—Ä–µ–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ!');
                    showErrorScreen();
                    return false;
                }
                return true;
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                return false;
            }
        }
        async function handleSubmit() {
            if (checkUserBookingLimit(booking.phone, booking.userId)) {
                showErrorScreen();
                return;
            }
            const bookingData = {
                ...booking,
                createdAt: new Date().toLocaleString('ru-RU'),
                timestamp: new Date().toISOString()
            };
            const success = await sendToGoogleSheets(bookingData);
            if (!success) return;
            document.getElementById('bookingScreen').classList.add('hidden');
            document.getElementById('successScreen').classList.remove('hidden');
            document.getElementById('successName').textContent = booking.name;
            document.getElementById('successPhone').textContent = booking.phone;
            document.getElementById('successDate').textContent = formatDate(booking.date);
            document.getElementById('successTime').textContent = booking.time;
            if (tg) {
                tg.MainButton.hide();
                tg.sendData(JSON.stringify(bookingData));
            }
        }
        function showErrorScreen() {
            document.getElementById('bookingScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.remove('hidden');
            if (tg) { tg.MainButton.hide(); }
        }
        renderDates();
        const nameInput = document.getElementById('nameInput');
        if (nameInput.value) { booking.name = nameInput.value; updateSubmitButton(); }
        loadBookedSlots();
    </script>
</body>
</html>
