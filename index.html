<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ë–∞—Ä–±–µ—Ä—à–æ–ø ‚Äî –ó–∞–ø–∏—Å—å</title>

<!-- Telegram WebApp SDK (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  /* ====== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –¢–ï–ú–´ ====== */
  :root{
    --bg: #0b0b0c;
    --panel: #0f1416;
    --muted: #9aa3a6;
    --text: #e6e9eb;
    --gold-1: #d4af37;
    --gold-2: #b8860b;
    --accent-1: #0ea5a4;
    --card-radius: 14px;
    --shadow: 0 10px 30px rgba(2,6,23,0.6);
  }
  /* —Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ (–ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) */
  @media (prefers-color-scheme: light) {
    :root{
      --bg: linear-gradient(180deg,#f5f7fb,#fdfaf6);
      --panel: #ffffff;
      --muted: #6b7280;
      --text: #0f172a;
      --gold-1: #8b6b1b;
      --gold-2: #6f4f0f;
      --accent-1: #0b7285;
      --shadow: 0 10px 30px rgba(8,15,30,0.06);
    }
  }

  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
  .container{max-width:980px;margin:28px auto;padding:20px;display:grid;grid-template-columns:1fr 360px;gap:22px}
  @media (max-width:980px){ .container{ grid-template-columns: 1fr; padding:12px } }

  /* Main card */
  .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); border-radius:var(--card-radius); padding:20px; box-shadow:var(--shadow); border: 1px solid rgba(255,255,255,0.02); }
  .brand { display:flex; gap:12px; align-items:center; }
  .logo { width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--gold-1),var(--gold-2)); color:rgba(12,10,7,0.95); display:flex; align-items:center; justify-content:center; font-weight:800; font-size:20px; box-shadow: 0 6px 18px rgba(0,0,0,0.35) inset; }
  h1{margin:0;font-size:20px;font-weight:700}
  p.lead{margin:6px 0 0;color:var(--muted);font-size:13px}

  .grid-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
  .field{flex:1;min-width:210px}
  label{display:block;font-weight:600;font-size:13px;margin-bottom:6px;color:var(--text)}
  input[type="text"], input[type="tel"]{width:100%;padding:11px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));color:var(--text);font-size:14px}
  input::placeholder{color:rgba(255,255,255,0.35)}

  .hint{font-size:12px;color:var(--muted);margin-top:6px}

  /* Dates grid */
  .dates{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
  @media (max-width:720px){ .dates{ grid-template-columns:repeat(2,1fr) } }
  .date-btn{
    padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
    color:var(--text);font-weight:700;cursor:pointer;font-size:14px;align-items:center;display:flex;flex-direction:column;justify-content:center;
    transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    text-align:center;box-shadow: 0 6px 18px rgba(0,0,0,0.25) inset;
  }
  .date-btn small{font-weight:600;color:var(--muted);display:block;margin-top:6px;font-size:12px}
  .date-btn:hover{transform:translateY(-4px)}
  .date-btn.active{
    background: linear-gradient(90deg, rgba(212,175,55,0.15), rgba(184,134,11,0.08));
    border:1px solid rgba(212,175,55,0.45);
    box-shadow: 0 12px 36px rgba(184,134,11,0.12);
    color:var(--gold-2);
    transform:translateY(-2px) scale(1.02);
  }

  /* Times grid */
  .times{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
  @media (max-width:720px){ .times{ grid-template-columns:repeat(3,1fr) } }
  .time-btn{
    padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);font-weight:700;cursor:pointer;transition:transform .12s, box-shadow .12s;
  }
  .time-btn:hover{transform:translateY(-3px)}
  .time-btn.active{ background: linear-gradient(90deg, #2b2b2b, rgba(212,175,55,0.05)); color:var(--gold-1); box-shadow: 0 8px 28px rgba(0,0,0,0.45) inset; transform:translateY(-2px) scale(1.03); border:1px solid rgba(212,175,55,0.25) }
  .time-btn.disabled{ background: rgba(255,255,255,0.02); color:rgba(255,255,255,0.35); cursor:not-allowed; border-style: dashed; filter:grayscale(0.2); }

  .meta{display:flex;align-items:center;justify-content:space-between;margin-top:14px;color:var(--muted);font-size:13px}

  /* Right aside */
  .aside{display:flex;flex-direction:column;gap:14px}
  .box{padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.02)}
  .success-icon{width:64px;height:64px;border-radius:12px;background:linear-gradient(90deg,var(--gold-1),var(--gold-2));display:flex;align-items:center;justify-content:center;color:#081017;font-weight:800;margin:0 auto 8px}
  .error-icon{width:64px;height:64px;border-radius:12px;background:linear-gradient(90deg,#ef4444,#dc2626);display:flex;align-items:center;justify-content:center;color:white;margin:0 auto 8px}

  .hidden{display:none !important}

  /* Fixed confirm button */
  .confirm-wrap{
    position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:1200;width:min(920px,calc(100% - 32px));
    display:flex;align-items:center;justify-content:center;pointer-events:auto;
  }
  .confirm-btn{
    width:100%;max-width:760px;padding:16px 22px;border-radius:14px;border:none;background:linear-gradient(90deg,var(--gold-1),var(--gold-2));color:#081017;font-weight:800;font-size:16px;cursor:pointer;box-shadow:0 12px 36px rgba(184,134,11,0.14);
    transition:transform .12s,opacity .12s;
  }
  .confirm-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}

  .spinner{width:28px;height:28px;border-radius:50%;border:3px solid rgba(255,255,255,0.08);border-top:3px solid rgba(255,255,255,0.25);animation:spin 1s linear infinite;margin:0 auto}
  @keyframes spin{to{transform:rotate(360deg)}}

  footer{margin-top:26px;text-align:center;color:var(--muted);font-size:13px}
</style>
</head>
<body>
  <div class="container">
    <div class="card" id="mainCard">
      <div class="brand">
        <div class="logo">–ë</div>
        <div>
          <h1>–ë–∞—Ä–±–µ—Ä—à–æ–ø ‚Äî –ó–∞–ø–∏—Å—å</h1>
          <p class="lead">–ü—Ä–µ–º–∏—É–º-–∑–∞–ø–∏—Å—å. –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è ‚Äî –º—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º –≤—Å—ë –∫ –≤–∞—à–µ–º—É –ø—Ä–∏—Ö–æ–¥—É.</p>
        </div>
      </div>

      <div class="grid-row">
        <div class="field">
          <label for="nameInput">–í–∞—à–µ –∏–º—è</label>
          <input id="nameInput" type="text" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
        </div>
        <div class="field">
          <label for="phoneInput">–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input id="phoneInput" type="tel" placeholder="+7 (999) 123-45-67" value="+7 ">
          <div class="hint">–ú–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏ Telegram ID</div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</label>
        <div id="datesGrid" class="dates" aria-live="polite"></div>
      </div>

      <div id="timeSection" class="hidden" style="margin-top:12px;">
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</label>
        <div id="timesGrid" class="times" aria-live="polite"></div>
      </div>

      <div class="meta">
        <div>üìç —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 123 ‚Äî –ü–Ω‚Äì–í—Å 09:00‚Äì19:00</div>
        <div class="small" id="statusText" style="color:var(--muted)">–î–æ—Å—Ç—É–ø–Ω–æ —Å–ª–æ—Ç–æ–≤: ‚Äî</div>
      </div>
    </div>

    <div class="aside">
      <div class="box" id="infoBox">
        <div style="font-weight:700;margin-bottom:6px">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
        <div class="small">–¢–µ–ª–µ—Ñ–æ–Ω: +7 (999) 123-45-67</div>
        <div class="small" style="margin-top:8px">–ê–¥—Ä–µ—Å: —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 123</div>
      </div>

      <div class="box hidden" id="successBox">
        <div class="success-icon">‚úì</div>
        <div style="font-weight:700;text-align:center;margin-bottom:6px">–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã!</div>
        <div id="successDetails" style="text-align:center;color:var(--text);font-weight:600"></div>
      </div>

      <div class="box hidden" id="errorBox">
        <div class="error-icon">‚ö†</div>
        <div style="font-weight:700;text-align:center;margin-bottom:6px">–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏</div>
        <div id="errorDetails" style="text-align:center;color:var(--text)"></div>
      </div>
    </div>
  </div>

  <!-- Fixed confirm button -->
  <div class="confirm-wrap">
    <button id="confirmBtn" class="confirm-btn" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
  </div>

  <footer>¬© –ë–∞—Ä–±–µ—Ä—à–æ–ø ‚Äî —É–¥–æ–±–Ω–∞—è –ø—Ä–µ–º–∏—É–º-–∑–∞–ø–∏—Å—å</footer>

<script>
/* ================== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ================== */
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx-qJ5_dsbafprTrO7sDJsp8Y1Os2Aa1dfwPuFG6s9R6m58ezsxMKrJMZctb0kiVNN0/exec'; // <-- –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL
const allTimeSlots = ['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00'];

/* ================ –°–æ—Å—Ç–æ—è–Ω–∏–µ ================ */
const booking = { name:'', phone:'', date:'', time:'', userId:null, username:'' };
let bookedSlots = {}; // {"2025-11-17_10:00": true}
let userBookingsToday = []; // {name,phone,date,time,userId}
let sending = false;
let tg = window.Telegram?.WebApp || null;

/* ================ Telegram init ================ */
if (tg) {
  try { tg.ready(); tg.expand(); }
  catch(e){ console.warn('tg ready error', e); }
  const user = tg.initDataUnsafe?.user || null;
  if (user) {
    booking.userId = user.id || null;
    booking.username = user.username || '';
    // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∏–º—è –µ—Å–ª–∏ –ø—É—Å—Ç–æ
    const nameEl = document.getElementById('nameInput');
    if (!nameEl.value) nameEl.value = (user.first_name || '') + (user.last_name ? ' ' + user.last_name : '');
    // Telegram theme (–µ—Å–ª–∏ –µ—Å—Ç—å) - –º–æ–∂–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ
    try {
      if (tg.themeParams && tg.themeParams.bg_color) {
        // (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –º–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ü–≤–µ—Ç–∞ –∏ –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—å -- –Ω–µ –¥–µ–ª–∞–µ–º –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ —Å–µ–π—á–∞—Å
      }
    } catch(e){}
    // –°–∫—Ä—ã–≤–∞–µ–º Telegram MainButton —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª –ª–æ–∫–∞–ª—å–Ω–æ–π –∫–Ω–æ–ø–∫–µ
    try { if (tg.MainButton && typeof tg.MainButton.hide === 'function') tg.MainButton.hide(); } catch(e){}
  }
}

/* ================ –£—Ç–∏–ª–∏—Ç—ã ================ */
function isoDate(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function formatDateForUI(dateStr) {
  const date = new Date(dateStr + 'T00:00:00');
  const today = new Date(); const todayStr = isoDate(today);
  const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1); const tom = isoDate(tomorrow);
  if (dateStr === todayStr) return '–°–µ–≥–æ–¥–Ω—è';
  if (dateStr === tom) return '–ó–∞–≤—Ç—Ä–∞';
  return date.toLocaleDateString('ru-RU',{weekday:'short',day:'numeric',month:'short'});
}
function normalizePhone(raw) {
  if (!raw) return '';
  let digits = raw.toString().replace(/\D/g,'');
  if (digits.startsWith('8')) digits = '7' + digits.slice(1);
  if (!digits.startsWith('7')) digits = '7' + digits;
  digits = digits.slice(0,11);
  if (digits.length !== 11) return '';
  return '+' + digits;
}
function show(id){ document.getElementById(id).classList.remove('hidden'); }
function hide(id){ document.getElementById(id).classList.add('hidden'); }

/* ================ –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä ================ */
async function loadBookedSlots() {
  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ, —á—Ç–æ –∏–¥—ë—Ç –∑–∞–≥—Ä—É–∑–∫–∞ (statusText)
  const status = document.getElementById('statusText');
  status.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤‚Ä¶';
  try {
    const res = await fetch(GOOGLE_SCRIPT_URL + '?action=getBookings', { cache: 'no-store' });
    if (!res.ok) throw new Error('–°–µ—Ç–µ–≤–æ–π –æ—Ç–≤–µ—Ç –Ω–µ OK: ' + res.status);
    const data = await res.json();
    bookedSlots = {};
    userBookingsToday = [];
    if (data && Array.isArray(data.bookings)) {
      data.bookings.forEach(b=>{
        const key = `${b.date}_${b.time}`;
        bookedSlots[key] = true;
        userBookingsToday.push({
          name: b.name || '',
          phone: normalizePhone(b.phone || ''),
          date: b.date || '',
          time: b.time || '',
          userId: b.userId || null
        });
      });
    }
    status.textContent = `–î–æ—Å—Ç—É–ø–Ω–æ —Å–ª–æ—Ç–æ–≤: ${countAvailableSlots()}`;
    return true;
  } catch (err) {
    console.error('loadBookedSlots error', err);
    status.textContent = '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤';
    return false;
  }
}

/* ================ –õ–æ–≥–∏–∫–∞ –¥–∞—Ç/–≤—Ä–µ–º—ë–Ω ================ */
function getAvailableDays() {
  const days = [];
  const now = new Date();
  const currentHour = now.getHours();
  const start = currentHour >= 18 ? 1 : 0;
  for (let i=start;i<start+7;i++){
    const d = new Date(); d.setDate(d.getDate()+i);
    days.push(isoDate(d));
  }
  return days;
}
function isSlotBooked(date, time) { return bookedSlots[`${date}_${time}`] === true; }
function getAvailableTimeSlots(selectedDate) {
  const now = new Date(), todayStr = isoDate(now), currentHour = now.getHours(), currentMinute = now.getMinutes();
  return allTimeSlots.filter(slot=>{
    if (isSlotBooked(selectedDate, slot)) return false;
    if (selectedDate === todayStr) {
      const [h,m] = slot.split(':').map(Number);
      const slotDate = new Date(); slotDate.setHours(h,m,0,0);
      const minAllowed = new Date(); minAllowed.setHours(currentHour+1,currentMinute,0,0);
      if (slotDate < minAllowed) return false;
    }
    return true;
  });
}
function countAvailableSlots() {
  const days = getAvailableDays();
  let total = 0;
  days.forEach(d=>{
    total += getAvailableTimeSlots(d).length;
  });
  return total;
}

/* ================ –†–µ–Ω–¥–µ—Ä UI ================ */
function renderDates() {
  const grid = document.getElementById('datesGrid');
  const days = getAvailableDays();
  grid.innerHTML = days.map(d=>{
    return `<button class="date-btn" data-date="${d}" aria-pressed="false">
      <div>${formatDateForUI(d)}</div>
      <small>${d}</small>
    </button>`;
  }).join('');
  // –¥–æ–±–∞–≤–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  document.querySelectorAll('.date-btn').forEach(btn=>{
    btn.addEventListener('click', function(){ selectDate(this.getAttribute('data-date'), this); });
  });
}
function renderTimes() {
  const grid = document.getElementById('timesGrid');
  const available = getAvailableTimeSlots(booking.date);
  if (!available.length) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--gold-1);font-weight:700;padding:12px">‚ùå –ù–∞ —ç—Ç—É –¥–∞—Ç—É –≤—Å–µ —Å–ª–æ—Ç—ã –∑–∞–Ω—è—Ç—ã.</div>';
    return;
  }
  grid.innerHTML = allTimeSlots.map(t=>{
    const isAvailable = available.includes(t);
    const cls = isAvailable ? 'time-btn' : 'time-btn disabled';
    const disabledAttr = isAvailable ? '' : 'disabled';
    return `<button class="${cls}" ${disabledAttr} data-time="${t}" aria-pressed="false">${t}</button>`;
  }).join('');
  // handlers
  document.querySelectorAll('#timesGrid .time-btn').forEach(btn=>{
    if (!btn.classList.contains('disabled')) {
      btn.addEventListener('click', function(){ selectTime(this.getAttribute('data-time'), this); });
    }
  });
}

/* ================ –í—ã–±–æ—Ä –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ ================ */
async function selectDate(date, el) {
  booking.date = date;
  booking.time = '';
  // –≤–∏–∑—É–∞–ª
  document.querySelectorAll('.date-btn').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
  el.classList.add('active'); el.setAttribute('aria-pressed','true');
  // –ø–æ–∫–∞–∑–∞—Ç—å times
  document.getElementById('timeSection').classList.remove('hidden');
  // —Å–ø–∏–Ω–Ω–µ—Ä –≤ times
  document.getElementById('timesGrid').innerHTML = '<div class="spinner" style="grid-column:1/-1;margin:12px auto"></div>';
  await loadBookedSlots();
  renderTimes();
  updateConfirmButton();
}

function selectTime(time, el) {
  booking.time = time;
  document.querySelectorAll('.time-btn').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
  el.classList.add('active'); el.setAttribute('aria-pressed','true');
  updateConfirmButton();
}

/* ================ –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∫–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ================ */
const nameInput = document.getElementById('nameInput'), phoneInput = document.getElementById('phoneInput');
nameInput.addEventListener('input', e => { booking.name = e.target.value.trim(); updateConfirmButton(); });
phoneInput.addEventListener('input', e => {
  // –ø—Ä–æ—Å—Ç–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  let v = e.target.value.replace(/\D/g,'');
  if (v.startsWith('8')) v = '7'+v.slice(1);
  if (!v.startsWith('7')) v = '7'+v;
  v = v.slice(0,11);
  let fmt = '+7 ';
  if (v.length > 1) fmt += '(' + v.substring(1,4);
  if (v.length >= 5) fmt += ') ' + v.substring(4,7);
  if (v.length >= 8) fmt += '-' + v.substring(7,9);
  if (v.length >= 10) fmt += '-' + v.substring(9,11);
  e.target.value = fmt;
  booking.phone = normalizePhone(fmt);
  updateConfirmButton();
});

phoneInput.addEventListener('keydown', (e)=>{ const pos = e.target.selectionStart; if ((e.key==='Backspace'||e.key==='Delete') && pos<=3) e.preventDefault(); });

function checkUserBookingLimit(phone, userId) {
  const today = isoDate(new Date());
  const phoneBookings = userBookingsToday.filter(b => b.phone === phone && b.date === today);
  const userIdBookings = userId ? userBookingsToday.filter(b => b.userId && String(b.userId) === String(userId) && b.date === today) : [];
  return phoneBookings.length > 0 || userIdBookings.length > 0;
}

function updateConfirmButton() {
  const btn = document.getElementById('confirmBtn');
  const valid = booking.name && booking.phone && booking.date && booking.time;
  btn.disabled = !valid || sending;
  // hide Telegram MainButton to avoid interference
  try { if (tg && tg.MainButton && typeof tg.MainButton.hide === 'function') tg.MainButton.hide(); } catch(e){}
}

/* ================ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø–∏—Å–∏ ================ */
async function handleConfirm() {
  if (sending) return;
  // ensure latest values
  booking.name = nameInput.value.trim();
  booking.phone = normalizePhone(phoneInput.value);
  // refresh booked slots right before send
  await loadBookedSlots();
  // local checks
  if (checkUserBookingLimit(booking.phone, booking.userId)) {
    showError('–í—ã —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –ø–æ —ç—Ç–æ–º—É —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏–ª–∏ Telegram ID.');
    return;
  }
  if (isSlotBooked(booking.date, booking.time)) {
    showError('–°–ª–æ—Ç —É–∂–µ –∑–∞–Ω—è—Ç. –û–±–Ω–æ–≤–∏–ª —Å–ø–∏—Å–æ–∫ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Å–ª–æ—Ç.');
    return;
  }
  // payload
  const payload = {
    name: booking.name,
    phone: booking.phone,
    date: booking.date,
    time: booking.time,
    userId: booking.userId || '',
    username: booking.username || '',
    createdAt: new Date().toLocaleString('ru-RU')
  };
  sending = true;
  updateConfirmButton();
  const btn = document.getElementById('confirmBtn');
  const origText = btn.textContent;
  btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
  try {
    const res = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + res.status);
    const result = await res.json();
    if (result && result.status === 'success') {
      // –ø–æ–º–µ—Ç–∏–º –ª–æ–∫–∞–ª—å–Ω–æ
      bookedSlots[`${payload.date}_${payload.time}`] = true;
      userBookingsToday.push({ name: payload.name, phone: payload.phone, date: payload.date, time: payload.time, userId: payload.userId || null });
      // UI: —É—Å–ø–µ—Ö
      document.querySelector('.card').classList.add('hidden');
      show('successBox');
      document.getElementById('successDetails').innerHTML = `<div style="font-size:16px">${payload.name}</div><div style="margin-top:6px">${payload.phone} ‚Ä¢ ${formatDateForUI(payload.date)} ‚Ä¢ ${payload.time}</div>`;
      // try to send data via Telegram if available
      if (tg && typeof tg.sendData === 'function') {
        try { tg.sendData(JSON.stringify(payload)); } catch(e){ console.warn('tg.sendData error', e); }
      }
    } else {
      const msg = (result && result.message) ? result.message : '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
      showError(msg);
    }
  } catch (err) {
    console.error('send error', err);
    showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  } finally {
    sending = false;
    btn.textContent = origText;
    updateConfirmButton();
  }
}

/* ================ –ü–æ–∫–∞–∑ –æ—à–∏–±–æ–∫ ================ */
function showError(msg) {
  show('errorBox');
  hide('successBox');
  document.getElementById('errorDetails').textContent = msg;
}

/* ================ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ================ */
(async function init(){
  renderDates();
  await loadBookedSlots();
  // –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
  if (nameInput.value) booking.name = nameInput.value.trim();
  booking.phone = normalizePhone(phoneInput.value);
  updateConfirmButton();
})();

/* ================ –°–æ–±—ã—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ================ */
document.getElementById('confirmBtn').addEventListener('click', handleConfirm);

/* –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ) */
window.selectDate = selectDate;
window.selectTime = selectTime;
window.handleConfirm = handleConfirm;
</script>
</body>
</html>
