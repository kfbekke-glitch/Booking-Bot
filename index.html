<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ë–∞—Ä–±–µ—Ä—à–æ–ø ‚Äî –ó–∞–ø–∏—Å—å</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* ---------- Base ---------- */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;padding:22px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:linear-gradient(135deg,#f7f8ff 0,#ffffff 100%);
    color:#0f172a;
  }
  .container{max-width:720px;margin:0 auto}
  .card{background:#fff;border-radius:14px;box-shadow:0 12px 30px rgba(12,20,40,0.06);overflow:hidden}
  .header{padding:18px 20px;background:linear-gradient(90deg,#5b21b6,#0891b2);color:#fff}
  .header h1{margin:0;font-size:20px}
  .header p{margin:8px 0 0 0;font-size:13px;opacity:.95}
  .form{padding:18px}
  .form-group{margin-bottom:14px}
  label{display:block;font-weight:700;margin-bottom:8px;color:#0f172a}
  input[type="text"],input[type="tel"]{
    width:100%;padding:12px 14px;border-radius:10px;border:1px solid #e6e9f2;font-size:15px;background:#fcfdff;
  }
  input:focus{outline:none;border-color:#7c3aed;box-shadow:0 6px 20px rgba(124,58,237,0.08)}
  .grid-dates{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:10px}
  .btn-date{padding:11px;border-radius:10px;border:0;background:#f3f4f6;cursor:pointer;font-weight:700;transition:all .18s ease}
  .btn-date:hover{transform:translateY(-3px)}
  .btn-date.active{background:linear-gradient(90deg,#7c3aed,#06b6d4);color:#fff;box-shadow:0 12px 30px rgba(59,130,246,0.12)}
  .grid-times{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .time-btn{padding:10px;border-radius:10px;border:0;background:#f3f4f6;cursor:pointer;font-weight:700;transition:all .14s ease}
  .time-btn:hover{transform:translateY(-2px)}
  .time-btn.active{background:linear-gradient(90deg,#7c3aed,#06b6d4);color:#fff}
  .time-btn.disabled{background:#fff5f5;color:#9b1c1c;cursor:not-allowed;border:1px solid rgba(220,38,38,0.08)}
  .actions{display:flex;gap:10px;flex-direction:column;margin-top:12px}
  .btn-primary{width:100%;padding:14px;border-radius:10px;border:0;background:linear-gradient(90deg,#10b981,#059669);color:#fff;font-weight:800;cursor:pointer;transition:transform .12s}
  .btn-primary:active{transform:scale(.997)}
  .btn-primary:disabled{opacity:.45;cursor:not-allowed}
  .btn-ghost{width:100%;padding:12px;border-radius:10px;border:0;background:#6366f1;color:#fff;font-weight:700;cursor:pointer}
  .muted{color:#64748b;font-size:13px}
  .info{padding:12px 18px;text-align:center;color:#64748b;font-size:13px}

  /* ---------- Modal overlay (center) ---------- */
  .overlay{
    position:fixed;left:0;top:0;width:100%;height:100%;display:none;
    align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:1200;
    backdrop-filter: blur(2px);
  }
  .overlay.show{display:flex;animation:fadeIn .18s ease forwards}

  @keyframes fadeIn{from{opacity:0}to{opacity:1}}

  .modal{
    width: min(720px, 92%);
    background:#fff;border-radius:14px;padding:18px;box-shadow:0 20px 60px rgba(2,6,23,0.16);
    transform: translateY(6px) scale(.98);
    opacity:0; transition: transform .22s cubic-bezier(.2,.9,.3,1), opacity .22s ease;
  }
  .overlay.show .modal{transform:translateY(0) scale(1);opacity:1}

  .modal h2{margin:6px 0 12px 0;font-size:20px}
  .modal .muted{margin-bottom:10px}

  .modal .booking-list{max-height:320px;overflow:auto;padding-right:6px}
  .booking-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:#f8fafc;margin-bottom:10px}
  .booking-item .left{display:flex;flex-direction:column}
  .booking-item .small{font-size:13px;color:#334155}

  .modal .actions{margin-top:12px;flex-direction:row}
  .modal .actions .btn{flex:1}

  /* small devices adjustments */
  @media (max-width:520px){
    .grid-dates{grid-template-columns:repeat(1,1fr)}
    .grid-times{grid-template-columns:repeat(2,1fr)}
  }
</style>
</head>
<body>
<div class="container">

  <div id="bookingCard" class="card" role="region" aria-label="–ó–∞–ø–∏—Å—å">
    <div class="header">
      <h1>–ë–∞—Ä–±–µ—Ä—à–æ–ø</h1>
      <p>–£–¥–æ–±–Ω–∞—è –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—å ‚Äî 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –Ω–æ–º–µ—Ä—É –∏ Telegram ID.</p>
    </div>

    <div class="form">
      <div class="form-group">
        <label for="nameInput">–í–∞—à–µ –∏–º—è</label>
        <input id="nameInput" type="text" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
      </div>

      <div class="form-group">
        <label for="phoneInput">–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input id="phoneInput" type="tel" placeholder="+7 (999) 123-45-67" value="+7 ">
      </div>

      <div class="form-group">
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</label>
        <div id="datesGrid" class="grid-dates" aria-live="polite"></div>
      </div>

      <div id="timeBlock" class="form-group" style="display:none">
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</label>
        <div id="timesGrid" class="grid-times" aria-live="polite"></div>
      </div>

      <div class="actions">
        <button id="submitBtn" class="btn-primary" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
        <button id="myBookingsBtn" class="btn-ghost">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</button>
      </div>

      <div class="info">üìç —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 123 ‚Äî –ü–Ω‚Äì–í—Å 09:00‚Äì19:00</div>
    </div>
  </div>

</div>

<!-- Modal (used for success/error/my bookings) -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true" onclick="overlayClick(event)">
  <div id="modal" class="modal" role="document" onclick="event.stopPropagation()">
    <!-- content injected dynamically -->
  </div>
</div>

<script>
/* ====== CONFIG - –≤—Å—Ç–∞–≤—å —Å–≤–æ–π URL ====== */
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyAZLUA2FDiAzMx6f4wmaqD2eKHOd38SZ45z_4chPg_ad2vtXJ8qhq_EkYTw5Cj61w/exec';
/* ===================================== */

const tg = window.Telegram?.WebApp || null;
if(tg){ try{tg.ready(); tg.expand();}catch(e){} try{ if(tg.MainButton) tg.MainButton.hide(); }catch(e){} }

const nameInput = document.getElementById('nameInput');
const phoneInput = document.getElementById('phoneInput');
const datesGrid = document.getElementById('datesGrid');
const timesGrid = document.getElementById('timesGrid');
const timeBlock = document.getElementById('timeBlock');
const submitBtn = document.getElementById('submitBtn');
const myBookingsBtn = document.getElementById('myBookingsBtn');

const overlay = document.getElementById('overlay');
const modal = document.getElementById('modal');

const tgUser = tg?.initDataUnsafe?.user || {};
const userId = tgUser.id || null;
const username = tgUser.username || '';

const allTimeSlots = ['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00'];

let bookedSlots = {};   // map date_time -> true
let todayBookings = []; // list of bookings
let selectedDate = '';
let selectedTime = '';
let sending = false;

/* Helpers */
function isoDate(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function toHHMM(v){ if(!v && v!==0) return ''; v=String(v).trim(); if(v.includes(':')){ let p=v.split(':'); return p.map(x=>('0'+x.replace(/\D/g,'')).slice(-2)).join(':'); } v=v.replace(/\D/g,''); if(v.length<=2) return ('0'+v).slice(-2)+':00'; if(v.length===3) return '0'+v[0]+':'+v.slice(1); if(v.length===4) return v.slice(0,2)+':'+v.slice(2); return v; }
function normalizePhone(raw){ if(!raw) return ''; let s=String(raw).replace(/\D/g,''); if(s.length===11 && s.startsWith('8')) s='7'+s.slice(1); if(s.length===10) s='7'+s; return s.length===11?('+'+s):s;}
function formatForUI(dateStr){ const today=isoDate(new Date()); const tomorrow=isoDate(new Date(Date.now()+86400000)); if(dateStr===today) return '–°–µ–≥–æ–¥–Ω—è'; if(dateStr===tomorrow) return '–ó–∞–≤—Ç—Ä–∞'; const d=new Date(dateStr+'T00:00:00'); return d.toLocaleDateString('ru-RU',{weekday:'short',day:'numeric',month:'short'}); }

/* UI functions for modal */
function showModal(html){
  modal.innerHTML = html;
  overlay.classList.add('show');
  overlay.setAttribute('aria-hidden','false');
}
function closeModal(){
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
  modal.innerHTML = '';
}
function overlayClick(e){
  // click on backdrop closes modal
  if(e.target === overlay) closeModal();
}

/* Date/time rendering */
function getNext7Days(){
  const out=[]; const now=new Date();
  for(let i=0;i<7;i++){ const d=new Date(); d.setDate(now.getDate()+i); out.push(isoDate(d)); }
  return out;
}
function renderDates(){
  datesGrid.innerHTML='';
  const days=getNext7Days();
  days.forEach(d=>{
    const btn=document.createElement('button');
    btn.className='btn-date'; btn.textContent=formatForUI(d);
    btn.onclick = ()=> selectDate(d, btn);
    datesGrid.appendChild(btn);
  });
}
function renderTimes(){
  timesGrid.innerHTML='';
  if(!selectedDate) return;
  const now=new Date();
  const threshold = new Date(now.getTime()+3600000); // now + 1 hour
  allTimeSlots.forEach(slot=>{
    const btn=document.createElement('button');
    btn.className='time-btn'; btn.textContent=slot;
    const slotDt = new Date(selectedDate + 'T' + slot + ':00');
    const key = `${selectedDate}_${slot}`;
    if(bookedSlots[key]){
      btn.classList.add('disabled');
      btn.title = '–ó–∞–Ω—è—Ç–æ';
    } else if(slotDt < threshold){
      btn.classList.add('disabled');
      btn.title = '–ü—Ä–æ—à–ª–æ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ';
    } else {
      btn.onclick = ()=> selectTime(slot, btn);
    }
    timesGrid.appendChild(btn);
  });
}

/* Select handlers */
function selectDate(date, btnEl){
  selectedDate = date; selectedTime = '';
  document.querySelectorAll('.btn-date').forEach(b=>b.classList.remove('active'));
  btnEl.classList.add('active');
  timeBlock.style.display = 'block';
  renderTimes();
  updateSubmit();
}
function selectTime(time, btnEl){
  selectedTime = toHHMM(time);
  document.querySelectorAll('.time-btn').forEach(b=>b.classList.remove('active'));
  btnEl.classList.add('active');
  updateSubmit();
}

function updateSubmit(){
  const name = nameInput.value.trim();
  const digits = phoneInput.value.replace(/\D/g,'');
  const ok = name.length>1 && digits.length===11 && selectedDate && selectedTime && !sending;
  submitBtn.disabled = !ok;
}

/* phone mask */
phoneInput.addEventListener('input', (e)=>{
  let v = e.target.value.replace(/\D/g,'');
  if(!v.startsWith('7')) v = '7' + v.replace(/^7+/, '');
  v = v.slice(0,11);
  let fmt = '+7 ';
  if(v.length>1) fmt += '(' + v.slice(1,4);
  if(v.length>=5) fmt += ') ' + v.slice(4,7);
  if(v.length>=8) fmt += '-' + v.slice(7,9);
  if(v.length>=10) fmt += '-' + v.slice(9,11);
  e.target.value = fmt;
  updateSubmit();
});

/* Prefill name if available */
if(tgUser.first_name && !nameInput.value) nameInput.value = tgUser.first_name + (tgUser.last_name ? (' ' + tgUser.last_name) : '');

async function safeJsonFetch(url, opts){
  try{
    const r = await fetch(url, opts);
    const txt = await r.text();
    try{ return JSON.parse(txt); } catch(e){ console.error('Invalid JSON', txt); return { error:'invalid_json', raw:txt }; }
  } catch(err){ console.error('Network', err); return { error:'network', message:String(err) }; }
}

/* Load bookings to mark occupied slots */
async function loadAllBookings(){
  if(!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL==='REPLACE_WITH_YOUR_WEB_APP_URL'){ console.warn('GAS URL not set'); return; }
  const res = await safeJsonFetch(GOOGLE_SCRIPT_URL + '?action=getBookings', { cache:'no-store' });
  bookedSlots = {}; todayBookings = [];
  if(res && Array.isArray(res.bookings)){
    res.bookings.forEach(b=>{
      const t = toHHMM(b.time||'');
      const key = `${b.date}_${t}`;
      bookedSlots[key] = true;
      todayBookings.push({ date:b.date, time:t, phone: normalizePhone(b.phone||''), userId: b.userId || '' });
    });
  } else {
    if(res && res.error) console.warn('loadAllBookings error', res);
  }
  if(selectedDate) renderTimes();
}

/* Open My Bookings modal */
async function openMyBookings(){
  if(!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL==='https://script.google.com/macros/s/AKfycbyAZLUA2FDiAzMx6f4wmaqD2eKHOd38SZ45z_4chPg_ad2vtXJ8qhq_EkYTw5Cj61w/exec'){
    showModal(`<h2>–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2><p class="muted">URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –∑–∞–¥–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.</p><div style="display:flex;gap:8px;margin-top:12px"><button onclick="closeModal()" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
    return;
  }

  const phone = normalizePhone(phoneInput.value);
  let qs = '?action=getUserBookings';
  if(userId) qs += '&userId=' + encodeURIComponent(String(userId));
  else if(phone) qs += '&phone=' + encodeURIComponent(String(phone));
  else { showModal(`<h2>–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2><p class="muted">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram.</p><div style="display:flex;gap:8px;margin-top:12px"><button onclick="closeModal()" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`); return; }

  showModal(`<h2>–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2><p class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</p>`);
  const res = await safeJsonFetch(GOOGLE_SCRIPT_URL + qs, { cache:'no-store' });

  if(res && Array.isArray(res.bookings) && res.bookings.length>0){
    // render list
    const items = res.bookings.sort((a,b)=> (a.date + a.time).localeCompare(b.date + b.time)).map(b=>{
      return `<div class="booking-item"><div class="left"><div style="font-weight:800">${formatForUI(b.date)} ‚Äî ${toHHMM(b.time)}</div><div class="small">${b.name || ''} ${b.phone ? '‚Ä¢ ' + normalizePhone(b.phone) : ''}</div></div><div class="small muted">${b.created || ''}</div></div>`;
    }).join('');
    showModal(`<h2>–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2><div class="booking-list">${items}</div><div style="display:flex;gap:8px;margin-top:12px" class="actions"><button onclick="closeModal()" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
  } else {
    const msg = (res && res.bookings && res.bookings.length===0) ? '–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π' : (res && res.error ? '–û—à–∏–±–∫–∞: ' + (res.message || res.error) : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
    showModal(`<h2>–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2><p class="muted">${msg}</p><div style="display:flex;gap:8px;margin-top:12px"><button onclick="closeModal()" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
  }
}

/* Send booking */
async function sendBooking(){
  if(sending) return;
  const name = nameInput.value.trim();
  const phone = normalizePhone(phoneInput.value);
  if(!name || !phone || !selectedDate || !selectedTime) return updateSubmit();

  // local check: already booked this day by phone or userId
  const conflict = todayBookings.some(b => b.date === selectedDate && (b.phone === phone || (userId && String(b.userId) === String(userId))));
  if(conflict){ showModal(`<h2>–û—à–∏–±–∫–∞</h2><p class="muted">–í—ã —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å (–ø–æ –Ω–æ–º–µ—Ä—É –∏–ª–∏ Telegram ID).</p><div style="display:flex;gap:8px;margin-top:12px"><button onclick="closeModal()" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`); return; }

  sending = true; updateSubmit(); submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

  const params = new URLSearchParams();
  params.append('action','addBooking');
  params.append('name', name);
  params.append('phone', phone);
  params.append('date', selectedDate);
  params.append('time', selectedTime);
  params.append('userId', userId || '');
  params.append('username', username || '');

  const res = await safeJsonFetch(GOOGLE_SCRIPT_URL, {
    method:'POST',
    headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
    body: params.toString()
  });

  if(res && res.status === 'success'){
    showModal(`<h2>–ó–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</h2><p class="muted">${name} ‚Ä¢ ${phone}</p><p>–î–∞—Ç–∞: <strong>${formatForUI(selectedDate)}</strong></p><p>–í—Ä–µ–º—è: <strong>${selectedTime}</strong></p><div style="display:flex;gap:8px;margin-top:12px"><button onclick="closeModal()" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
    // refresh slots so it becomes disabled
    await loadAllBookings();
  } else {
    const msg = (res && res.message) ? res.message : '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ —Å–µ—Ç–∏';
    showModal(`<h2>–û—à–∏–±–∫–∞</h2><p class="muted">${msg}</p><div style="display:flex;gap:8px;margin-top:12px"><button onclick="closeModal()" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
    await loadAllBookings();
  }

  sending = false; submitBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å';
  updateSubmit();
}

/* events */
submitBtn.addEventListener('click', sendBooking);
myBookingsBtn.addEventListener('click', openMyBookings);

/* visibility refresh */
document.addEventListener('visibilitychange', ()=>{
  if(!document.hidden) loadAllBookings().catch(()=>{});
});

/* init */
(async function init(){
  renderDates();
  if(tgUser.first_name) nameInput.value = tgUser.first_name + (tgUser.last_name ? (' ' + tgUser.last_name) : '');
  await loadAllBookings();
  updateSubmit();
})();

</script>
</body>
</html>
