<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ë–∞—Ä–±–µ—Ä—à–æ–ø ‚Äî –ó–∞–ø–∏—Å—å</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:linear-gradient(135deg,#f3f5ff 0,#fff 100%);margin:0;padding:18px;color:#1f2937}
  .container{max-width:520px;margin:0 auto}
  .card{background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(20,20,50,0.06);overflow:hidden;margin-bottom:18px}
  .header{padding:22px 24px;background:linear-gradient(135deg,#6b21a8,#2563eb);color:#fff}
  .header h1{margin:0;font-size:20px}
  .header p{margin:6px 0 0 0;opacity:.95;font-size:13px}
  .form{padding:20px}
  .form-group{margin-bottom:18px}
  label.label{display:block;font-weight:700;margin-bottom:8px;color:#374151}
  input[type="text"],input[type="tel"]{width:100%;padding:12px;border-radius:10px;border:1px solid #e6e9f2;font-size:15px}
  .dates-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .btn-date{padding:12px;border-radius:12px;border:0;background:#f3f4f6;cursor:pointer;font-weight:600}
  .btn-date.active{background:linear-gradient(90deg,#7c3aed,#06b6d4);color:#fff;box-shadow:0 8px 24px rgba(59,130,246,.12);transform:translateY(-2px)}
  .times-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .time-btn{padding:12px 6px;border-radius:12px;border:0;background:#f3f4f6;cursor:pointer;font-weight:600}
  .time-btn.active{background:linear-gradient(90deg,#7c3aed,#06b6d4);color:#fff}
  .time-btn.disabled{background:#fff0f0;color:#9b1c1c;cursor:not-allowed;box-shadow:none;border:1px solid rgba(220,38,38,0.08)}
  .confirm-row{padding:16px 20px}
  .confirm-btn{width:100%;padding:14px;border-radius:12px;border:0;background:linear-gradient(90deg,#10b981,#059669);color:#fff;font-weight:800;font-size:16px;cursor:pointer}
  .confirm-btn:disabled{opacity:.45;cursor:not-allowed}
  .info{padding:12px 20px;text-align:center;color:#6b7280;font-size:13px}
  /* success / error */
  .result-card{padding:28px 20px;text-align:center;border-radius:16px}
  .success{background:linear-gradient(180deg,#f0fff6,#ffffff);color:#064e3b}
  .error{background:linear-gradient(180deg,#fff5f5,#ffffff);color:#7f1d1d}
  .result-card h2{margin:0 0 8px 0;font-size:20px}
  .result-card p{margin:6px 0;color:inherit}
  /* small helpers */
  .muted{color:#6b7280;font-size:13px}
  .hidden{display:none}
</style>
</head>
<body>
<div class="container">
  <div id="bookingCard" class="card">
    <div class="header">
      <h1>–ë–∞—Ä–±–µ—Ä—à–æ–ø</h1>
      <p>–£–¥–æ–±–Ω–∞—è –∑–∞–ø–∏—Å—å ‚Äî 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏ Telegram ID.</p>
    </div>
    <div class="form">
      <div class="form-group">
        <label class="label">–í–∞—à–µ –∏–º—è</label>
        <input id="nameInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
      </div>
      <div class="form-group">
        <label class="label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input id="phoneInput" type="tel" placeholder="+7 (999) 123-45-67" value="+7 ">
      </div>

      <div class="form-group">
        <label class="label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</label>
        <div id="datesGrid" class="dates-grid"></div>
      </div>

      <div id="timeBlock" class="form-group" style="display:none">
        <label class="label">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</label>
        <div id="timesGrid" class="times-grid"></div>
      </div>

      <div class="confirm-row">
        <button id="submitBtn" class="confirm-btn" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
      </div>
    </div>
  </div>

  <div id="successCard" class="card hidden">
    <div class="result-card success">
      <h2>–ó–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!</h2>
      <p id="successName" class="muted"></p>
      <p id="successPhone" class="muted"></p>
      <p>–î–∞—Ç–∞: <strong id="successDate"></strong></p>
      <p>–í—Ä–µ–º—è: <strong id="successTime"></strong></p>
    </div>
  </div>

  <div id="errorCard" class="card hidden">
    <div class="result-card error">
      <h2>–û—à–∏–±–∫–∞</h2>
      <p id="errorMessage" class="muted"></p>
    </div>
  </div>

  <div class="info">
    üìç —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 123 ‚Äî –ü–Ω‚Äì–í—Å 09:00‚Äì19:00
  </div>
</div>

<script>
/* ====== –ö–æ–Ω—Ñ–∏–≥ - –∑–∞–º–µ–Ω–∏—Ç–µ URL –Ω–∞ –≤–∞—à Web App URL ====== */
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbytvAbi0Zk2BNNIYk4VtU3devO2qv7tRJACXxZyqsVmVVdLBHovHihqXn7lr50eDfNT/exec";
/* ===================================================== */

const tg = window.Telegram?.WebApp || null;
if (tg) {
  try { tg.ready(); tg.expand(); } catch(e){}
  // –°–∫—Ä—ã–≤–∞–µ–º MainButton –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
  try { if (tg.MainButton) tg.MainButton.hide(); } catch(e){}
}

const allTimeSlots = ['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00'];

const nameInput = document.getElementById('nameInput');
const phoneInput = document.getElementById('phoneInput');
const datesGrid = document.getElementById('datesGrid');
const timesGrid = document.getElementById('timesGrid');
const timeBlock = document.getElementById('timeBlock');
const submitBtn = document.getElementById('submitBtn');

const successCard = document.getElementById('successCard');
const bookingCard = document.getElementById('bookingCard');
const errorCard = document.getElementById('errorCard');
const errorMessage = document.getElementById('errorMessage');

const successName = document.getElementById('successName');
const successPhone = document.getElementById('successPhone');
const successDateEl = document.getElementById('successDate');
const successTimeEl = document.getElementById('successTime');

let bookedSlots = {}; // { '2025-11-17_09:00': true }
let todayBookings = []; // [{name,phone,date,time,userId}]
let selectedDate = '';
let selectedTime = '';
let sending = false;

const tgUser = tg?.initDataUnsafe?.user || {};
let userId = tgUser.id || null;
let username = tgUser.username || null;

/* ===== helpers ===== */
function isoDate(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function pad2(n){ return String(n).padStart(2,'0'); }
function nowPlusHours(h){ const d=new Date(); d.setHours(d.getHours()+h); return d; }
function toHHMM(t){ // normalize input to HH:MM
  if (!t) return '';
  t = String(t).trim();
  if (/:/.test(t)){
    const parts = t.split(':').map(s=>s.replace(/\D/g,''));
    const hh = pad2(parts[0]||'0'); const mm = pad2(parts[1]||'0');
    return `${hh}:${mm}`;
  } else {
    // e.g. "9" or "900"
    if (t.length<=2) return pad2(t)+':00';
    if (t.length===3) return '0'+t[0]+':'+t.slice(1);
    if (t.length===4) return t.slice(0,2)+':'+t.slice(2);
    return t;
  }
}
function formatForUI(dateStr){
  const d = new Date(dateStr + 'T00:00:00');
  const today = isoDate(new Date());
  const tomorrow = isoDate(new Date(Date.now()+24*3600*1000));
  if (dateStr === today) return '–°–µ–≥–æ–¥–Ω—è';
  if (dateStr === tomorrow) return '–ó–∞–≤—Ç—Ä–∞';
  return d.toLocaleDateString('ru-RU',{weekday:'short',day:'numeric',month:'short'});
}
function normalizePhone(raw){
  if(!raw) return '';
  let s = String(raw).replace(/\D/g,'');
  if (s.length===11 && s[0]==='8') s = '7'+s.slice(1);
  if (s.length===10) s = '7'+s;
  if (s.length!==11) return s;
  return '+'+s;
}

/* ===== generate dates (7 days) ===== */
function getNextDays(){
  const out=[];
  const today = new Date();
  for(let i=0;i<7;i++){
    const d = new Date();
    d.setDate(today.getDate()+i);
    out.push(isoDate(d));
  }
  return out;
}

/* ===== render dates ===== */
function renderDates(){
  datesGrid.innerHTML = '';
  const days = getNextDays();
  days.forEach(d=>{
    const btn = document.createElement('button');
    btn.className = 'btn-date';
    btn.textContent = formatForUI(d);
    btn.dataset.date = d;
    btn.addEventListener('click', (ev)=>{
      selectDate(d, ev.currentTarget);
    });
    datesGrid.appendChild(btn);
  });
}

/* ===== load bookings from GAS (GET?action=getBookings) ===== */
async function loadBookedSlots(){
  try{
    const resp = await fetch(GOOGLE_SCRIPT_URL + '?action=getBookings', {cache:'no-store'});
    const data = await resp.json();
    bookedSlots = {};
    todayBookings = [];
    if (data && Array.isArray(data.bookings)){
      data.bookings.forEach(b=>{
        const timeNorm = toHHMM(b.time || '');
        const key = `${b.date}_${timeNorm}`;
        bookedSlots[key] = true;
        todayBookings.push({ name: b.name || '', phone: normalizePhone(b.phone||''), date: b.date||'', time: timeNorm, userId: b.userId || '' });
      });
    }
    // if a date is already selected - re-render times
    if (selectedDate) renderTimes();
  }catch(err){
    console.error('loadBookedSlots error', err);
  }
}

/* ===== compute available time slots: ensure slot >= now + 1 hour ===== */
function getAvailableTimeSlotsForDate(dateStr){
  const now = new Date();
  const threshold = new Date(now.getTime() + 60*60*1000); // now + 1 hour
  return allTimeSlots.filter(slot=>{
    const slotParts = slot.split(':').map(n=>parseInt(n,10));
    const slotDate = new Date(dateStr + 'T00:00:00');
    slotDate.setHours(slotParts[0], slotParts[1]||0, 0, 0);
    // if slot already booked -> unavailable
    if (bookedSlots[`${dateStr}_${slot}`]) return false;
    // if slot datetime < threshold -> unavailable
    if (slotDate < threshold) return false;
    return true;
  });
}

/* ===== render times ===== */
function renderTimes(){
  timesGrid.innerHTML = '';
  if (!selectedDate) return;
  const avail = getAvailableTimeSlotsForDate(selectedDate);
  allTimeSlots.forEach(slot=>{
    const btn = document.createElement('button');
    btn.className = 'time-btn';
    btn.textContent = slot;
    // normalize key
    const key = `${selectedDate}_${slot}`;
    if (bookedSlots[key]){
      btn.classList.add('disabled');
      btn.title = '–ó–∞–Ω—è—Ç–æ';
    } else {
      // check threshold: is slot in avail?
      if (!avail.includes(slot)){
        btn.classList.add('disabled');
        btn.title = '–ü—Ä–æ—à–ª–æ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ';
      } else {
        btn.addEventListener('click', (ev)=> selectTime(slot, ev.currentTarget));
      }
    }
    timesGrid.appendChild(btn);
  });
}

/* ===== select date/time handlers ===== */
function selectDate(date, el){
  selectedDate = date;
  selectedTime = '';
  // active class
  document.querySelectorAll('.btn-date').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  // show grid
  timeBlock.style.display = 'block';
  // reload slots (in case server updated)
  loadBookedSlots().then(()=> renderTimes());
  updateSubmitButton();
}

function selectTime(time, el){
  selectedTime = toHHMM(time);
  document.querySelectorAll('.time-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  updateSubmitButton();
}

/* ===== validation / limit check ===== */
function isLimitExceededByPhoneOrUser(phone, uid, dateStr){
  // dateStr in yyyy-mm-dd
  return todayBookings.some(b => {
    if (b.date !== dateStr) return false;
    if (b.userId && uid && String(b.userId) === String(uid)) return true;
    if (b.phone && phone && b.phone === phone) return true;
    return false;
  });
}

function updateSubmitButton(){
  const name = nameInput.value.trim();
  const phoneDigits = phoneInput.value.replace(/\D/g,'');
  const valid = name.length>1 && phoneDigits.length===11 && selectedDate && selectedTime && !sending;
  submitBtn.disabled = !valid;
}

/* ===== phone formatting listeners ===== */
phoneInput.addEventListener('input', e=>{
  let v = e.target.value.replace(/\D/g,'');
  if (!v.startsWith('7')) v = '7' + v.replace(/^7+/,'');
  v = v.slice(0,11);
  let formatted = '+7 ';
  if (v.length>1) formatted += '('+v.slice(1,4);
  if (v.length>=5) formatted += ') '+v.slice(4,7);
  if (v.length>=8) formatted += '-'+v.slice(7,9);
  if (v.length>=10) formatted += '-'+v.slice(9,11);
  e.target.value = formatted;
  updateSubmitButton();
});

/* prefill name from tg user if available */
if (tg?.initDataUnsafe?.user){
  const u = tg.initDataUnsafe.user;
  if (u.first_name && !nameInput.value) nameInput.value = u.first_name + (u.last_name ? ' '+u.last_name : '');
}

/* ===== send booking (URL-encoded to avoid preflight) ===== */
async function sendBooking(){
  if (sending) return;
  const name = nameInput.value.trim();
  const phone = normalizePhone(phoneInput.value);
  if (!name || !phone || !selectedDate || !selectedTime) return;

  // check local limit
  if (isLimitExceededByPhoneOrUser(phone, userId, selectedDate)){
    showError('–í—ã —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å (–ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏–ª–∏ Telegram ID).');
    return;
  }

  sending = true;
  updateSubmitButton();
  submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

  const payload = {
    action: 'addBooking',
    name: name,
    phone: phone,
    date: selectedDate,
    time: selectedTime,
    userId: userId || '',
    username: username || ''
  };

  try {
    const form = new URLSearchParams();
    for (const k in payload) form.append(k, payload[k]);

    const resp = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body: form.toString(),
      cache:'no-store'
    });

    const result = await resp.json();

    if (result && result.status === 'success'){
      // success UI
      bookingCard.classList.add('hidden');
      successCard.classList.remove('hidden');
      successName.textContent = name;
      successPhone.textContent = phone;
      successDateEl.textContent = formatForUI(selectedDate);
      successTimeEl.textContent = selectedTime;
      // refresh booked slots
      await loadBookedSlots();
    } else {
      const msg = (result && result.message) ? result.message : '–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É';
      showError(msg);
      // refresh slots in case server reports slot busy
      await loadBookedSlots();
    }
  } catch(err){
    console.error('send error', err);
    showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  } finally {
    sending = false;
    submitBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å';
    updateSubmitButton();
  }
}

function showError(msg){
  errorMessage.textContent = msg;
  bookingCard.classList.add('hidden');
  errorCard.classList.remove('hidden');
}

/* wire events */
submitBtn.addEventListener('click', sendBooking);

/* init */
(async function init(){
  renderDates();
  await loadBookedSlots();
  // initial button update
  updateSubmitButton();
})();
</script>
</body>
</html>
