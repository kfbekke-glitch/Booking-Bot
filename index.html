<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ë–∞—Ä–±–µ—Ä—à–æ–ø ‚Äî –ó–∞–ø–∏—Å—å</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:linear-gradient(135deg,#f3f5ff 0,#fff 100%);margin:0;padding:18px;color:#1f2937}
  .container{max-width:520px;margin:0 auto}
  .card{background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(20,20,50,0.06);overflow:hidden;margin-bottom:18px}
  .header{padding:22px 24px;background:linear-gradient(135deg,#6b21a8,#2563eb);color:#fff}
  .header h1{margin:0;font-size:20px}
  .header p{margin:6px 0 0 0;opacity:.95;font-size:13px}
  .form{padding:20px}
  .form-group{margin-bottom:18px}
  label.label{display:block;font-weight:700;margin-bottom:8px;color:#374151}
  input[type="text"],input[type="tel"]{width:100%;padding:12px;border-radius:10px;border:1px solid #e6e9f2;font-size:15px}

  .dates-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .btn-date{padding:12px;border-radius:12px;border:0;background:#f3f4f6;cursor:pointer;font-weight:600}
  .btn-date.active{background:linear-gradient(90deg,#7c3aed,#06b6d4);color:#fff;box-shadow:0 8px 24px rgba(59,130,246,.12);transform:translateY(-2px)}

  .times-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .time-btn{padding:12px 6px;border-radius:12px;border:0;background:#f3f4f6;cursor:pointer;font-weight:600}
  .time-btn.active{background:linear-gradient(90deg,#7c3aed,#06b6d4);color:#fff}
  .time-btn.disabled{background:#fff0f0;color:#9b1c1c;cursor:not-allowed;box-shadow:none;border:1px solid rgba(220,38,38,0.08)}

  .confirm-row{padding:16px 20px}
  .confirm-btn{width:100%;padding:14px;border-radius:12px;border:0;background:linear-gradient(90deg,#10b981,#059669);color:#fff;font-weight:800;font-size:16px;cursor:pointer}
  .confirm-btn:disabled{opacity:.45;cursor:not-allowed}

  .info{padding:12px 20px;text-align:center;color:#6b7280;font-size:13px}

  .result-card{padding:28px 20px;text-align:center;border-radius:16px}
  .success{background:linear-gradient(180deg,#f0fff6,#ffffff);color:#064e3b}
  .error{background:linear-gradient(180deg,#fff5f5,#ffffff);color:#7f1d1d}
  .result-card h2{margin:0 0 8px 0;font-size:20px}
  .result-card p{margin:6px 0;color:inherit}

  .muted{color:#6b7280;font-size:13px}
  .hidden{display:none}

  /* MY BOOKINGS */
  #myBookingsCard .result-card {
    background:#f8f9ff;
  }
</style>
</head>
<body>
<div class="container">

  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
  <div id="bookingCard" class="card">
    <div class="header">
      <h1>–ë–∞—Ä–±–µ—Ä—à–æ–ø</h1>
      <p>–£–¥–æ–±–Ω–∞—è –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—å ‚Äî 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å</p>
    </div>
    <div class="form">
      <div class="form-group">
        <label class="label">–í–∞—à–µ –∏–º—è</label>
        <input id="nameInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
      </div>
      <div class="form-group">
        <label class="label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input id="phoneInput" type="tel" placeholder="+7 (999) 123-45-67" value="+7 ">
      </div>

      <div class="form-group">
        <label class="label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</label>
        <div id="datesGrid" class="dates-grid"></div>
      </div>

      <div id="timeBlock" class="form-group" style="display:none">
        <label class="label">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</label>
        <div id="timesGrid" class="times-grid"></div>
      </div>

      <div class="confirm-row">
        <button id="submitBtn" class="confirm-btn" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
      </div>

      <div class="confirm-row">
        <button class="confirm-btn" style="background:linear-gradient(90deg,#6366f1,#4f46e5)" onclick="openMyBookings()">
          –ú–æ–∏ –∑–∞–ø–∏—Å–∏
        </button>
      </div>
    </div>
  </div>

  <!-- –£—Å–ø–µ—Ö -->
  <div id="successCard" class="card hidden">
    <div class="result-card success">
      <h2>–ó–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!</h2>
      <p id="successName" class="muted"></p>
      <p id="successPhone" class="muted"></p>
      <p>–î–∞—Ç–∞: <strong id="successDate"></strong></p>
      <p>–í—Ä–µ–º—è: <strong id="successTime"></strong></p>
    </div>
  </div>

  <!-- –û—à–∏–±–∫–∞ -->
  <div id="errorCard" class="card hidden">
    <div class="result-card error">
      <h2>–û—à–∏–±–∫–∞</h2>
      <p id="errorMessage" class="muted"></p>
    </div>
  </div>

  <!-- –ú–æ–∏ –∑–∞–ø–∏—Å–∏ -->
  <div id="myBookingsCard" class="card hidden">
    <div class="result-card">
      <h2 style="color:#374151">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2>
      <div id="myBookingsList"></div>

      <button style="
        margin-top:16px;
        padding:10px 16px;
        border:none;
        background:#e0e7ff;
        border-radius:10px;
        font-weight:600;
        cursor:pointer;
      " onclick="closeMyBookings()">
        –ó–∞–∫—Ä—ã—Ç—å
      </button>
    </div>
  </div>

  <div class="info">
    üìç —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 123  
    ‚è∞ –ü–Ω‚Äì–í—Å 09:00‚Äì19:00
  </div>
</div>

<script>
/* =============== CONFIG =============== */
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxkvP9JiSXnmM2EtQOgM4pUoaWgkKc1Jtf1RISuoSKdzAd2UKn4OPIn_vCRtbA8e1OM/exec";

/* =============== TELEGRAM =============== */
const tg = window.Telegram?.WebApp || null;
if(tg){
  try{tg.ready(); tg.expand();}catch(e){}
}

/* =============== DOM =============== */
const nameInput = document.getElementById('nameInput');
const phoneInput = document.getElementById('phoneInput');
const datesGrid = document.getElementById('datesGrid');
const timesGrid = document.getElementById('timesGrid');
const timeBlock = document.getElementById('timeBlock');
const submitBtn = document.getElementById('submitBtn');

const bookingCard = document.getElementById('bookingCard');
const successCard = document.getElementById('successCard');
const errorCard = document.getElementById('errorCard');

const successName = document.getElementById('successName');
const successPhone = document.getElementById('successPhone');
const successDateEl = document.getElementById('successDate');
const successTimeEl = document.getElementById('successTime');

const errorMessage = document.getElementById('errorMessage');

const myBookingsCard = document.getElementById('myBookingsCard');
const myBookingsList = document.getElementById('myBookingsList');

/* =============== GLOBALS =============== */
const tgUser = tg?.initDataUnsafe?.user || {};
const userId = tgUser.id || null;
const username = tgUser.username || "";

const allTimeSlots = [
  '09:00','10:00','11:00','12:00','13:00',
  '14:00','15:00','16:00','17:00','18:00'
];

let bookedSlots = {};
let todayBookings = [];
let selectedDate = '';
let selectedTime = '';
let sending = false;

/* =============== HELPERS =============== */
function isoDate(d){
  return d.toISOString().split("T")[0];
}
function normalizeTime(t){
  if(!t) return "";
  const s=t.split(":");
  return ("0"+s[0]).slice(-2)+":"+("0"+s[1]).slice(-2);
}
function normalizePhone(p){
  let s=(p||"").replace(/\D/g,"");
  if(s.length===11 && s[0]==='8') s='7'+s.slice(1);
  if(s.length===10) s='7'+s;
  return s.length===11?('+'+s):s;
}
function formatDateUI(dateStr){
  const today=isoDate(new Date());
  const tomorrow=isoDate(new Date(Date.now()+86400000));
  if(dateStr===today) return "–°–µ–≥–æ–¥–Ω—è";
  if(dateStr===tomorrow) return "–ó–∞–≤—Ç—Ä–∞";
  return new Date(dateStr+"T00:00:00").toLocaleDateString("ru-RU",{weekday:"short",day:"numeric",month:"short"});
}

/* =============== LOAD BOOKINGS =============== */
async function loadBooked(){
  try{
    const r = await fetch(GOOGLE_SCRIPT_URL + "?action=getBookings");
    const data = await r.json();
    bookedSlots = {};
    todayBookings = [];

    data.bookings.forEach(b=>{
      const t = normalizeTime(b.time);
      bookedSlots[b.date+"_"+t] = true;
      todayBookings.push({
        date:b.date,time:t,phone:normalizePhone(b.phone),userId:b.userId
      });
    });

    if(selectedDate) renderTimes();
  }catch(e){console.error(e);}
}

/* =============== RENDER DATES =============== */
function renderDates(){
  datesGrid.innerHTML="";
  const days=[];
  for(let i=0;i<7;i++){
    const d=new Date();
    d.setDate(d.getDate()+i);
    days.push(isoDate(d));
  }
  days.forEach(date=>{
    const btn=document.createElement("button");
    btn.className="btn-date";
    btn.textContent=formatDateUI(date);
    btn.onclick=()=>selectDate(date,btn);
    datesGrid.appendChild(btn);
  });
}

/* =============== RENDER TIMES =============== */
function renderTimes(){
  timesGrid.innerHTML="";
  if(!selectedDate) return;

  const now = new Date();
  const threshold = new Date(now.getTime()+3600000);

  allTimeSlots.forEach(time=>{
    const btn=document.createElement("button");
    btn.className="time-btn";
    btn.textContent=time;

    const slotDate=new Date(selectedDate+"T"+time+":00");

    if(bookedSlots[selectedDate+"_"+time]){
      btn.classList.add("disabled");
    }
    else if(slotDate < threshold){
      btn.classList.add("disabled");
    }
    else{
      btn.onclick=()=>selectTime(time,btn);
    }

    timesGrid.appendChild(btn);
  });
}

/* =============== SELECT HANDLERS =============== */
function selectDate(date,btn){
  selectedDate=date;
  selectedTime='';
  document.querySelectorAll('.btn-date').forEach(e=>e.classList.remove('active'));
  btn.classList.add('active');
  timeBlock.style.display='block';
  renderTimes();
  updateSubmit();
}
function selectTime(time,btn){
  selectedTime=time;
  document.querySelectorAll('.time-btn').forEach(e=>e.classList.remove('active'));
  btn.classList.add('active');
  updateSubmit();
}

/* =============== SUBMITVALIDATION =============== */
function updateSubmit(){
  const name=nameInput.value.trim();
  const phone=normalizePhone(phoneInput.value);

  const valid=name && phone.length===12 && selectedDate && selectedTime && !sending;
  submitBtn.disabled=!valid;
}

/* =============== PHONE MASK =============== */
phoneInput.addEventListener('input',e=>{
  let v=e.target.value.replace(/\D/g,"");
  if(!v.startsWith("7")) v="7"+v.replace(/^7+/,'');
  v=v.slice(0,11);
  let f="+7 ";
  if(v.length>1) f+="("+v.slice(1,4);
  if(v.length>=5) f+=") "+v.slice(4,7);
  if(v.length>=8) f+="-"+v.slice(7,9);
  if(v.length>=10) f+="-"+v.slice(9,11);
  e.target.value=f;
  updateSubmit();
});

/* =============== SEND BOOKING =============== */
async function sendBooking(){
  if(sending) return;

  const name=nameInput.value.trim();
  const phone=normalizePhone(phoneInput.value);

  // –ª–∏–º–∏—Ç
  if(todayBookings.some(b=>b.date===selectedDate && (b.phone===phone || String(b.userId)===String(userId)))){
    return showError("–í—ã —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –ø–æ –Ω–æ–º–µ—Ä—É –∏–ª–∏ Telegram ID");
  }

  sending=true;
  updateSubmit();
  submitBtn.textContent="–û—Ç–ø—Ä–∞–≤–∫–∞...";

  const form = new URLSearchParams();
  form.append("action","addBooking");
  form.append("name",name);
  form.append("phone",phone);
  form.append("date",selectedDate);
  form.append("time",selectedTime);
  form.append("userId",userId||"");
  form.append("username",username||"");

  try{
    const r = await fetch(GOOGLE_SCRIPT_URL,{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:form.toString()
    });

    const data = await r.json();

    if(data.status==="success"){
      bookingCard.classList.add("hidden");
      successCard.classList.remove("hidden");

      successName.textContent=name;
      successPhone.textContent=phone;
      successDateEl.textContent=formatDateUI(selectedDate);
      successTimeEl.textContent=selectedTime;

      await loadBooked();
    }else{
      showError(data.message||"–û—à–∏–±–∫–∞");
      await loadBooked();
    }
  }catch(e){
    showError("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
  }

  sending=false;
  submitBtn.textContent="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å";
  updateSubmit();
}

submitBtn.onclick=sendBooking;

/* =============== ERROR =============== */
function showError(msg){
  errorMessage.textContent=msg;
  bookingCard.classList.add("hidden");
  myBookingsCard.classList.add("hidden");
  successCard.classList.add("hidden");
  errorCard.classList.remove("hidden");
}

/* =============== MY BOOKINGS =============== */
async function openMyBookings(){
  const r = await fetch(GOOGLE_SCRIPT_URL+"?action=getUserBookings&userId="+userId);
  const data = await r.json();

  myBookingsList.innerHTML="";

  if(!data.bookings || data.bookings.length===0){
    myBookingsList.innerHTML="<p class='muted'>–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>";
  }else{
    data.bookings.forEach(b=>{
      const div=document.createElement("div");
      div.style.padding="10px 0";
      div.style.borderBottom="1px solid #e5e7eb";

      div.innerHTML=`
        <p><strong>${b.date}</strong> –≤ <strong>${normalizeTime(b.time)}</strong></p>
        <p class="muted">${b.phone}</p>
      `;
      myBookingsList.appendChild(div);
    });
  }

  bookingCard.classList.add("hidden");
  errorCard.classList.add("hidden");
  successCard.classList.add("hidden");
  myBookingsCard.classList.remove("hidden");
}

function closeMyBookings(){
  myBookingsCard.classList.add("hidden");
  bookingCard.classList.remove("hidden");
}

/* =============== INIT =============== */
(async function init(){
  if(tgUser.first_name){
    nameInput.value = tgUser.first_name + 
      (tgUser.last_name ? (" "+tgUser.last_name) : "");
  }
  renderDates();
  await loadBooked();
  updateSubmit();
})();
</script>
</body>
</html>
