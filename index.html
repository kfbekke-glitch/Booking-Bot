<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–∞—Ä–±–µ—Ä—à–æ–ø ‚Äî –ó–∞–ø–∏—Å—å</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ece9ff 0%, #f7f5ff 100%);
            padding: 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .card {
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .header {
            padding: 24px;
            background: linear-gradient(135deg, #7b2ff7 0%, #4c72ff 100%);
            color: white;
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
        }

        .header-subtitle {
            opacity: 0.9;
            margin-top: 4px;
        }

        .form {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 22px;
        }

        .label {
            font-size: 14px;
            color: #444;
            font-weight: 600;
            margin-bottom: 8px;
        }

        input {
            width: 100%;
            border: 2px solid #ddd;
            padding: 12px 14px;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: 0.2s;
        }

        input:focus {
            border-color: #7b2ff7;
        }

        .dates-grid {
            display: grid;
            grid-template-columns: repeat(2,1fr);
            gap: 10px;
        }

        .btn-date {
            background: #f0f0f6;
            border: none;
            border-radius: 12px;
            padding: 12px;
            font-size: 14px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-date:hover {
            background: #e1e1ec;
        }

        .btn-date.active {
            background: linear-gradient(135deg,#7b2ff7,#4c72ff);
            color: white;
            font-weight: 700;
        }

        .times-grid {
            display: grid;
            grid-template-columns: repeat(3,1fr);
            gap: 10px;
        }

        .time-btn {
            background: #f0f0f6;
            border: none;
            padding: 12px 0;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            transition: 0.2s;
        }

        .time-btn.active {
            background: linear-gradient(135deg,#7b2ff7,#4c72ff);
            color: white;
            font-weight: bold;
        }

        .time-btn.disabled {
            background: #ffd6d6;
            color: #a60000;
            pointer-events: none;
            position: relative;
        }

        .confirm-btn {
            margin-top: 20px;
            width: 100%;
            background: linear-gradient(135deg,#00c26f,#009a54);
            border: none;
            padding: 16px;
            border-radius: 14px;
            color: white;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }

        .confirm-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .success-screen,
        .error-screen {
            padding: 30px;
            text-align: center;
        }

        .info-block {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-top: 30px;
        }
    </style>
</head>
<body>

<div class="container">

    <!-- –ë–õ–û–ö –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø -->
    <div class="card" id="bookingScreen">
        <div class="header">
            <div class="header-title">–ë–∞—Ä–±–µ—Ä—à–æ–ø</div>
            <div class="header-subtitle">–ó–∞–ø–∏—Å—å –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É</div>
        </div>

        <div class="form">

            <div class="form-group">
                <div class="label">–í–∞—à–µ –∏–º—è</div>
                <input type="text" id="nameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
            </div>

            <div class="form-group">
                <div class="label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
                <input type="tel" id="phoneInput" placeholder="+7 (999) 123-45-67" value="+7 ">
            </div>

            <div class="form-group">
                <div class="label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</div>
                <div class="dates-grid" id="datesGrid"></div>
            </div>

            <div class="form-group" id="timeBlock" style="display:none;">
                <div class="label">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</div>
                <div class="times-grid" id="timesGrid"></div>
            </div>

            <button class="confirm-btn" id="submitBtn" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>

        </div>
    </div>

    <!-- –≠–ö–†–ê–ù –£–°–ü–ï–•–ê -->
    <div class="card hidden" id="successScreen">
        <div class="success-screen">
            <h2>–ó–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!</h2>
            <p id="successName"></p>
            <p id="successPhone"></p>
            <p>–î–∞—Ç–∞: <span id="successDate"></span></p>
            <p>–í—Ä–µ–º—è: <span id="successTime"></span></p>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù –û–®–ò–ë–ö–ò -->
    <div class="card hidden" id="errorScreen">
        <div class="error-screen">
            <h2 style="color:#a60000;">–û—à–∏–±–∫–∞</h2>
            <p id="errorText"></p>
        </div>
    </div>

    <div class="info-block">
        üìç —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 123<br>
        üìû +7 (999) 123-45-67<br>
        ‚è∞ –ü–Ω-–í—Å: 09:00-19:00
    </div>

</div>
<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    const GOOGLE_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbxCiXOcmcmm_SHn7T_GGFH_VAHxfY8Pzqx9n41xm1Gi9moz2MOjOQDwy9WWOYEcAaCf/exec";

    const allSlots = [
        "09:00", "10:00", "11:00", "12:00",
        "13:00", "14:00", "15:00", "16:00",
        "17:00", "18:00"
    ];

    let selectedDate = "";
    let selectedTime = "";
    let bookedSlots = {};  // { '2025-11-20_09:00': true }
    let todayBookings = []; // —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–ª—è –ª–∏–º–∏—Ç–∞)

    const nameInput = document.getElementById("nameInput");
    const phoneInput = document.getElementById("phoneInput");
    const datesGrid = document.getElementById("datesGrid");
    const timesGrid = document.getElementById("timesGrid");
    const timeBlock = document.getElementById("timeBlock");
    const submitBtn = document.getElementById("submitBtn");

    const userId = tg.initDataUnsafe?.user?.id || null;
    const username = tg.initDataUnsafe?.user?.username || null;


    /* ================================
       –ê–í–¢–û–ü–û–î–°–¢–ê–ù–û–í–ö–ê –ò–ú–ï–ù–ò
    ================================= */
    if (tg.initDataUnsafe?.user?.first_name) {
        nameInput.value =
            tg.initDataUnsafe.user.first_name +
            (tg.initDataUnsafe.user.last_name ? " " + tg.initDataUnsafe.user.last_name : "");
    }


    /* ================================
       –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –¢–ï–õ–ï–§–û–ù–ê
    ================================= */
    phoneInput.addEventListener("input", (e) => {
        let v = e.target.value.replace(/\D/g, "");
        if (!v.startsWith("7")) v = "7" + v.replace(/^7+/, "");
        v = v.slice(0, 11);

        let formatted = "+7 ";
        if (v.length > 1) formatted += "(" + v.slice(1, 4);
        if (v.length >= 5) formatted += ") " + v.slice(4, 7);
        if (v.length >= 8) formatted += "-" + v.slice(7, 9);
        if (v.length >= 10) formatted += "-" + v.slice(9, 11);

        e.target.value = formatted;

        updateSubmitButton();
    });


    /* ================================
       –ì–ï–ù–ï–†–ê–¶–ò–Ø –ë–õ–ò–ñ–ê–ô–®–ò–• 7 –î–ù–ï–ô
    ================================= */
    function getDates() {
        const days = [];
        const now = new Date();

        for (let i = 0; i < 7; i++) {
            let d = new Date();
            d.setDate(now.getDate() + i);
            days.push(d.toISOString().split("T")[0]);
        }
        return days;
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString("ru-RU", { weekday: "short", day: "numeric", month: "short" });
    }


    /* ================================
       –†–ï–ù–î–ï–† –î–ê–¢
    ================================= */
    function renderDates() {
        const days = getDates();

        datesGrid.innerHTML = "";

        days.forEach((d) => {
            let btn = document.createElement("button");
            btn.className = "btn-date";
            btn.textContent = formatDate(d);
            btn.onclick = () => selectDate(d);

            datesGrid.appendChild(btn);
        });
    }


    /* ================================
       –†–ï–ù–î–ï–† –í–†–ï–ú–ï–ù–ò
    ================================= */
    function renderTimes() {
        timesGrid.innerHTML = "";

        allSlots.forEach((t) => {
            let key = `${selectedDate}_${t}`;
            let btn = document.createElement("button");

            btn.className = "time-btn";
            btn.textContent = t;

            if (bookedSlots[key]) {
                btn.classList.add("disabled");
            } else {
                btn.onclick = () => selectTime(t);
            }

            timesGrid.appendChild(btn);
        });
    }


    /* ================================
       –í–´–ë–û–† –î–ê–¢–´
    ================================= */
    function selectDate(date) {
        selectedDate = date;
        selectedTime = "";

        [...datesGrid.children].forEach((b) => b.classList.remove("active"));
        event.target.classList.add("active");

        timeBlock.style.display = "block";

        renderTimes();
        updateSubmitButton();
    }


    /* ================================
       –í–´–ë–û–† –í–†–ï–ú–ï–ù–ò
    ================================= */
    function selectTime(time) {
        selectedTime = time;

        [...timesGrid.children].forEach((b) => b.classList.remove("active"));
        event.target.classList.add("active");

        updateSubmitButton();
    }


    /* ================================
       –ü–†–û–í–ï–†–ö–ê –õ–ò–ú–ò–¢–ê (1 –∑–∞–ø–∏—Å—å –≤ –¥–µ–Ω—å)
    ================================= */
    function isLimitExceeded(phone, userId) {
        const today = new Date().toISOString().split("T")[0];

        const byPhone = todayBookings.some(
            (b) => b.phone === phone && b.date === today
        );

        const byUser = todayBookings.some(
            (b) => b.userId === String(userId) && b.date === today
        );

        return byPhone || byUser;
    }


    /* ================================
       –ê–ö–¢–ò–í–ê–¶–ò–Ø –ö–ù–û–ü–ö–ò
    ================================= */
    function updateSubmitButton() {
        const name = nameInput.value.trim();
        const phone = phoneInput.value.replace(/\D/g, "");

        const valid =
            name.length > 1 &&
            phone.length === 11 &&
            selectedDate &&
            selectedTime;

        submitBtn.disabled = !valid;
    }


    /* ================================
       –ó–ê–ì–†–£–ó–ö–ê –ó–ê–ù–Ø–¢–´–• –°–õ–û–¢–û–í
    ================================= */
    async function loadBookedSlots() {
        try {
            const res = await fetch(GOOGLE_SCRIPT_URL + "?action=getBookings");
            const data = await res.json();

            bookedSlots = {};
            todayBookings = [];

            data.bookings.forEach((b) => {
                let key = `${b.date}_${b.time}`;
                bookedSlots[key] = true;
                todayBookings.push(b);
            });

            renderTimes();
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", e);
        }
    }

    loadBookedSlots();
    renderDates();

    /* ================================
       –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–ò–°–ò –í GOOGLE SHEETS
    ================================= */
    async function sendBooking() {
        const name = nameInput.value.trim();
        const phone = phoneInput.value.replace(/\D/g, "");

        if (isLimitExceeded(phone, userId)) {
            tg.showAlert("–í—ã —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã —Å–µ–≥–æ–¥–Ω—è! –ú–æ–∂–Ω–æ 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å.");
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

        const formData = new FormData();
        formData.append("action", "addBooking");
        formData.append("name", name);
        formData.append("phone", phone);
        formData.append("date", selectedDate);
        formData.append("time", selectedTime);
        formData.append("userId", userId);
        formData.append("username", username || "");
        formData.append("created", new Date().toLocaleString("ru-RU"));

        try {
            const res = await fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                body: formData
            });

            const data = await res.json();

            if (data.status === "success") {
                tg.showPopup({
                    title: "–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞",
                    message:
                        `–î–∞—Ç–∞: ${selectedDate}\n–í—Ä–µ–º—è: ${selectedTime}\n–ú—ã –≤–∞—Å –∂–¥—ë–º!`,
                    buttons: [{ id: "ok", type: "ok" }]
                });

                loadBookedSlots();
            } else {
                tg.showAlert("–û—à–∏–±–∫–∞: " + data.message);
            }
        } catch (e) {
            console.error(e);
            tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
        }

        submitBtn.disabled = false;
        submitBtn.textContent = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å";
    }

    submitBtn.addEventListener("click", sendBooking);
</script>

</body>
</html>
